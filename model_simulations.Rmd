---
title: "model_simulations"
author: ""
date: "2025-05-29"
output: html_document
---

README: code for running all model simulations and plotting main text figures and associated supplemental figures 

takes ~2.5 hours to run everything

```{r setup, include=FALSE}

library("tictoc") # for timing simulations

```

# functions

all functions required for running model simulations

```{r}

################## DEMOGRAPHIC RATE FUNCTIONS ####################### 

# these functions consist of:
# 1) functions describing relationships between host size and demographic rates and for calculating the average of these rates over specified size classes
# 2) functions describing the effects of the partner on host growth and mortality and the effects of the host on partner mortality

# relationship between individual host area and fecundity 
# Fmn = area at which the host become reproductively mature
# Fconst = baseline fecundity upon reaching reproductive maturity
# Fexp = rate at which fecundity increases exponentially with area
FofA <- function(A, Fmn, Fconst, Fexp){
  
  if(A < Fmn){ # if the host area is less than the threshold for reproductive maturity
    f <- 0 # fecundity is zero
  } else{ # if host area is greater than the threshold for reproductive maturity
    
    f <- Fconst*exp(Fexp*(A-Fmn)) # fecundity increases exponentially
    
  }
  
}

FofA <- Vectorize(FofA, "A")


# function for calculating average fecundity within size range from x1 to x2 (where both are larger than the min size of reproductive maturity, Fmn)
# x1 = lower bound (host area) of integration range
# x2 = upper bound (host area) of integration range
# Fmn = area at which the host become reproductively mature
# Fconst = baseline fecundity upon reaching reproductive maturity
# Fexp = rate at which fecundity increases exponentially with area

avg_fec <- function(x1, x2, Fmn, Fconst, Fexp){
  
  if(Fexp != 0){
    # integral of c*exp(k*x) = c*1/k*exp(k*x)
    #avg <- (Fconst*exp(Fexp*x2)*1/Fexp-Fconst*exp(Fexp*x1)*1/Fexp)*1/(x2-x1)
    
    # integral of c*exp(k*(x-Fmn)) = c*1/k*exp(k*(x-Fmn))
    avg <- (Fconst*exp(Fexp*(x2-Fmn))*1/Fexp-Fconst*exp(Fexp*(x1-Fmn))*1/Fexp)*1/(x2-x1)
    
  } else{
    # integral of c*1 = (c*x2 - c*x1)
    avg <- (Fconst*x2 - Fconst*x1)/(x2-x1) # just Fconst
  }
  
  
  return(avg)
  
}



# growth: assume diameter follows von Bertalanffy growth curve
# some studies have used it for corals:
# Cafarelli et al. 2017 https://doi.org/10.1016/j.ecolmodel.2016.12.015

# use the basic growth equation to calculate the time it takes an individual to grow through a size class and use that to get the transition probability

# von Bert growth: L(t) = Linf*(1-exp(-k*t))

# age at length: log(1-L(t)/Linf)/-k

# make a function that takes the current size as an input and returns the size one month earlier (note this assumes an even distribution within size classes)
# A = host area at time t + 1
# Dinf = max host diameter 
# g = von Bert growth rate

S1ofA <- function(A, Dinf, g){
  # first convert area to diameter
  # A = pi*(D/2)^2
  D <- sqrt(A/pi)*2
  
  # diameter one timestep earlier
  D0 <- (1-exp(log(1-D/Dinf)+g))*Dinf
  
  # area one timestep earlier:
  A0 <- pi*(D0/2)^2
  
  return(A0)
}

# then proportion that grow from A0 to >= A in class from A1 to A would be (A-A0)/(A-A1)



# function for calculating host mortality as a function of host area (declining exponential)
# A = host area
# a = how much higher the mortality of a host of area 0 is than the asymptotic mortality rate
# b = rate at which mortality declines with increasing host area
# c = asymptotic mortality rate approached by the largest individuals

MofA <- function(A, a,b, c){
  
  m <- a*exp(-b*A) + c # c = lowest mortality rate will go, c + a = mortality of smallest size
  
}

MofA <- Vectorize(MofA, "A")


# function for calculating average mortality within size range from x1 to x2
# x1 = lower bound (host area) of integration range
# x2 = upper bound (host area) of integration range
# a = how much higher the mortality of a host of area 0 is than the asymptotic mortality rate
# b = rate at which mortality declines with increasing host area
# c = asymptotic mortality rate approached by the largest individuals


avg_mort <- function(x1, x2, a, b, c){
  
  if(b !=0){
    # integral of a*exp(-bx) + c = a*-1/b*exp(-bx) + cx
    avg <- (a*-1/b*exp(-b*x2) + c*x2 +a*1/b*exp(-b*x1) - c*x1)*1/(x2-x1)
  } else{
    # integral of a*1 + c = (a + c)*x2 - (a + c)*x1
    avg <- ((a + c)*x2 - (a + c)*x1)/(x2-x1)
  }
  
  
  return(avg)
  
}


# Effects of partner on host and effects of host on partner 

# function for calculating asymptotic host mortality (c in MofA function) as a function of partner abundance
# c0 = baseline asymptotic mortality rate in absence of partner
# exp_c = rate at which the asymptotic mortality rate declines with partner abundance
# c_mn = lowest possible density independent mortality rate
# P = partner abundance (per host)

MofP <- function(c0, exp_c, c_mn, P){
  
  if(is.na(P)==T){
    c <- c0
  } else{
    c <- (c0-c_mn)*exp(-exp_c*P) + c_mn
  }
  
  return(c)
  
}



MofP <- Vectorize(MofP, "P")

# function for calculating host growth rate (g in S1ofA function) as a function of partner abundance
# g0 = baseline growth host rate in absence of partner
# exp_g = rate at which host growth rate increases with partner abundance
# g_mx = maximum host growth rate
# P = partner abundance (per host)

GofP <- function(g0, exp_g, g_mx, P){
  
  if(is.na(P)==T){
    g <- g0
  } else{
    g <- g0 + (g_mx-g0)*(1-exp(-exp_g*P))
  }
  
  return(g)
  
}



GofP <- Vectorize(GofP, "P")



# function for calculating Fconst as a function of partner abundance
# Fconst0 = baseline host fecundity in absence of partner
# exp_F = rate at which host fecundity increases with partner abundance
# Fconst_mx = maximum baseline host fecundity
# P = partner abundance (per host)

FofP <- function(Fconst0, exp_F, Fconst_mx, P){
  
  if(is.na(P)==T){
    Fconst <- Fconst0
  } else{
    Fconst <- Fconst0 + (Fconst_mx-Fconst0)*(1-exp(-exp_F*P))
  }
  
  return(Fconst)
  
}

FofP <- Vectorize(FofP, "P")

# function for calculating partner density dependent mortality rate as a function of host area
# K0 = partner density dependent mortality on a host of area 0
# slope_mP = controls rate at which partner DD mortality decreases with host area
# A = host area

MPofA <- function(K0, slope_mP, A){
  
  #mP <- 1/(slope_mP*A)
  
  mP <- 1/(slope_mP*A^(3/2) + K0)
  
  
  return(mP)
  
}

MPofA <- Vectorize(MPofA, "A")

# average this 
# x1 = lower bound (host area) of integration range
# x2 = upper bound (host area) of integration range
# K0 = partner density dependent mortality on a host of area 0
# slope_mP = controls rate at which partner DD mortality decreases with host area

avg_Pmort <- function(x1, x2, K0, slope_mP){
  
  
  # integral of 1/(slope_mP*A) is log(slope_mP*A)*1/slope_mP
  #avg <- (log(slope_mP*x2)*1/slope_mP - log(slope_mP*x1)*1/slope_mP)/(x2-x1)
  
  # integral of 1/(slope_mP*A^(3/2) + K0) is complicated, calculated using Mathematica
  
  
  if(slope_mP == 0){
    
    avg <- 1/K0
    
  } else{
    
    if(K0 > 0){
      int.x2 <- 1/(3*slope_mP^(2/3)*K0^(1/3))*(log(abs(slope_mP^(2/3)*x2-slope_mP^(1/3)*K0^(1/3)*sqrt(x2)+K0^(2/3)))+2*sqrt(3)*atan((2*slope_mP^(1/3)*K0^(2/3)*sqrt(x2)-K0)/(sqrt(3)*K0))-2*log(abs(slope_mP*sqrt(x2)+slope_mP^(2/3)*K0^(1/3))))
      
      int.x1 <- 1/(3*slope_mP^(2/3)*K0^(1/3))*(log(abs(slope_mP^(2/3)*x1-slope_mP^(1/3)*K0^(1/3)*sqrt(x1)+K0^(2/3)))+2*sqrt(3)*atan((2*slope_mP^(1/3)*K0^(2/3)*sqrt(x1)-K0)/(sqrt(3)*K0))-2*log(abs(slope_mP*sqrt(x1)+slope_mP^(2/3)*K0^(1/3))))
      
    } else{
      int.x2 <- -2/(slope_mP*sqrt(x2))
      int.x1 <- -2/(slope_mP*sqrt(x1))
    }
    
    avg <- (int.x2 - int.x1)/(x2-x1)
    
  }
  
  
  
  return(avg)
  
}


################## PARTNER BEHAVIOR ########################################

# function for distributing settlers according to preference for adults vs juveniles
# phi = strength of preference for large hosts
# A_tots = total area covered by hosts in each size class

phi_fun <- function(phi, A_tots){
  
  # go to all size classes
  p1 <- A_tots/sum(A_tots)
  # go to largest size classes only
  p2 <- c(0, A_tots[2]/sum(A_tots[2:3]), A_tots[3]/sum(A_tots[2:3]))
  
  p <- (1-phi)*p1 + phi*p2
  
  return(p)
  
  
}


##################### BASIC MODEL FUNCTION #############################

# parameters
# tmax = max timepoint in simulation
# P0 = initial partner population densities on each host size class (vector)
# H0 = initial host densities in each size class (vector)
# rP = partner reproduction rate (same on all host size classes)
# nP = partner density independent mortality rate (same on all host size classes)
# mP_pars = parameters for relationship btw partner density dependent mortality rates and host area (named list with parameters slope_mP and K0)
# eP = partner external recruitment
# nH_pars = parameters for calculating host density independent mortality rates as a function of partner abundance (named list with elements a_n, b_n, c_n0, exp_cn, and cn_mx)
# mH_pars = parameters for calculating host density dep mortality (named list with elements a_m, b_m, and c_m)
# G_pars = parameters for calculating host growth rates as a function of partner abundance (named list with elements Dinf, g0, exp_g, g_mx, and Dmin)
# F_pars = parameters for calculating host fecundities (named list with elements Fmn, Fconst, Fexp)
# eH = host external recruitment
# Apatch = total patch area (carrying capacity for the host)
# z = whether the system is open (0) or closed (1)
# phi = strength of preference for adult hosts

mod_fun3 <- function(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi){
  
  
  # unlist parameters
  # partner DD mortality
  K0 <- mP_pars$K0; slope_mP <- mP_pars$slope_mP
  
  # host dens-indep mortality
  a_n <- nH_pars$a_n; b_n <- nH_pars$b_n; c_n0 <- nH_pars$c_n0; exp_cn <- nH_pars$exp_cn; cn_mn <- nH_pars$cn_mn
  
  # host density dep mortality
  a_m <- mH_pars$a_m; b_m <- mH_pars$b_m; c_m <- mH_pars$c_m
  
  # host growth
  Dinf <- G_pars$Dinf; g0 <- G_pars$g0; exp_g <- G_pars$exp_g; g_mx <- G_pars$g_mx
  Dmin <- G_pars$Dmin
  
  # host fecundity
  Fmn <- F_pars$Fmn; Fconst <- F_pars$Fconst; Fexp <- F_pars$Fexp
  
  # calculate fixed parameters
  # boundaries of the host size classes: 0-Fmn, Fmn-90% of max size, >90% of max size
  Amax <- pi*(1/2*Dinf)^2
  Amin <- pi*(1/2*Dmin)^2
  A12 <- Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class)
  A <- c((Amin+A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  # partner density dependent mortality in each size class (depend on areas in each class)
  mP <- c(avg_Pmort(Amin, A12, K0, slope_mP), avg_Pmort(A12, A23, K0, slope_mP), avg_Pmort(A23, Amax, K0, slope_mP))
  
  # host fecundities in each size class
  FH <- c(0, avg_fec(A12, A23, Fmn, Fconst, Fexp), avg_fec(A23, Amax, Fmn, Fconst, Fexp))
  
  # host density dependent mortality rates in each size class
  mH <- c(avg_mort(Amin, A12, a_m, b_m, c_m), avg_mort(A12, A23, a_m, b_m, c_m), avg_mort(A23, Amax, a_m, b_m, c_m))
  
  # vector of time steps
  tset <- seq(from = 0, to = tmax, by = 1) # time steps for iterating over
  
  # holding matrices and initial conditions
  # host
  Hmat <- matrix(NA, nrow = length(A), ncol = length(tset))
  Hmat[ ,1] <- H0
  
  # partner
  Pmat <- matrix(NA, nrow = length(A), ncol = length(tset))
  Pmat[ ,1] <- P0
  
  
  for(i in 2:length(tset)){ # for each time step in the simulation
    
    # calculate the area occupied
    Atot <- sum(A*Hmat[, i-1])
    
    # calculate the host growth rates as a function of P per unit host
    g_i <- GofP(g0, exp_g, g_mx, Pmat[, i-1]/Hmat[, i-1])
    
    # calculate size class transitions
    # class 1 to 2:
    A0_1 <- S1ofA(A12, Dinf, g_i[1])
    G12 <- ifelse(A0_1 < Amin, 1, (A12-A0_1)/(A12-Amin)) # proportion that grew into next size class; if area at previous timestep is less than Amin, say 100% of class 1 grew to class 2
    
    # class 2 to 3: 
    A0_2 <- S1ofA(A23, Dinf, g_i[2])
    G23 <- ifelse(A0_2 < A12, 1, (A23-A0_2)/(A23-A12)) # proportion that grew into next size class; if area at previous timestep is in size class 1 (A02 < A12), say 100% of class 2 grew to class 3
    
    G <- c(G12, G23, 0)
    
    # calculate host dens-indep mortality rates as a function of P per host
    c_n <- MofP(c_n0, exp_cn, cn_mn, Pmat[, i-1]/Hmat[, i-1])
    nH <- c(avg_mort(Amin, A12, a_n, b_n, c_n[1]), avg_mort(A12, A23, a_n, b_n, c_n[2]), avg_mort(A23, Amax, a_n, b_n, c_n[3]))
    
    # calculate the host growth and survival rates
    G_Ht <- G*max(0, 1-Atot/Apatch) # realized growth depends on how much room there is
    S_Ht <- exp(-(nH + mH*Atot/Apatch)) # mH*Atot/Apatch*Hmat[, i-1]
    
    # calculate the survival rates for the partner
    S_P <- rep(NA, 3)
    
    for(sss in 1:3){
      if(Hmat[sss,i-1] == 0){
        S_P[sss] <- 0
      } else{
        S_P[sss] <- exp(-(nP + mP[sss]*Pmat[sss, i-1]/Hmat[sss,i-1])) # mortality depends on P/H
      }
    }
    
    # make the host transition matrix
    T_H <- matrix(rep(0, length(S_Ht)^2), nrow = length(S_Ht), ncol = length(S_Ht))
    # fill in the first row (note fecundities are done separately below)
    T_H[1, 1] <- (1-G_Ht[1])*S_Ht[1]
    
    # make the fish transition matrix
    T_P <- matrix(rep(0, length(S_Ht)^2), nrow = length(S_Ht), ncol = length(S_Ht))
    # fill in the first row
    T_P[1, 1] <- (1-G_Ht[1])*S_P[1]*S_Ht[1]
    
    
    # fill in the rest
    for(mm in 2:length(S_Ht)){
      
      # host
      T_H[mm, mm] <- (1-G_Ht[mm])*S_Ht[mm] # surviving and staying put
      T_H[mm, mm-1] <- G_Ht[mm-1]*S_Ht[mm-1] # surviving and growing to next size class
      
      # partner
      T_P[mm, mm] <- (1-G_Ht[mm])*S_P[mm]*S_Ht[mm] # surviving and staying put
      T_P[mm, mm-1] <- G_Ht[mm-1]*S_P[mm-1]*S_Ht[mm-1] # surviving and growing to next size class
    }
    
    # calculate the new population sizes
    Hmat[, i] <- T_H %*% Hmat[, i-1]
    Pmat[, i] <- T_P %*% Pmat[, i-1]
    
    
    
    # new recruits for the fish: distribute across the size classes according to preference function
    # total recruits (depends on whether population is open or closed)
    Rtot <- z*sum(rP*Pmat[ ,i-1]) + (1-z)*eP
    
    # preferences
    # phi_fun(phi, Amax, A_mids, A_tots)
    
    if(sum(Hmat[, i-1])==0){ # if there are no hosts
      pxset <- c(0, 0, 0) 
    } else{
      
      pxset <- phi_fun(phi, A*Hmat[, i-1])
    } 
    
    
    # calculate recruit survival
    S_R <- rep(NA, 3)
    
    for(sss in 1:3){
      if(Hmat[sss,i-1] == 0){ # index here needs to match index used for P/H (i or i-1)
        S_R[sss] <- 0
      } else{
        S_R[sss] <- exp(-(nP + mP[sss]*Pmat[sss, i-1]/Hmat[sss, i-1]))
      }
    }
    
    # add new recruits 
    Pmat[, i] <- Pmat[, i] +  pxset*Rtot*S_R 
    
    # add new recruits for the host (depends on whether population is open or closed)
    Hmat[1, i] <- Hmat[1, i] + z*sum(FH*Hmat[ ,i-1])*max(0, 1-Atot/Apatch) + (1-z)*eH*max(0, 1-Atot/Apatch)
    
    
    
    
  }
  
  
  
  return(list(t = tset, H = Hmat, P = Pmat))
  
}



################ TERNARY SEARCH ALGORITHMS ###############################

# ternary search algorithm for finding the ecological optimum (partner biomass maximizing) phi value
# left0 = initial leftmost value of phi
# right0 = initial rightmost value of phi
# error_tol = error tolerance for optimum value
# eqtol = tolerance level for whether model has equilibrated (prop difference btw abundance at time tmax and time tmax-10)

phiTSA_fun <- function(left0, right0, error_tol, eqtol, tmax, P0, H0, rP, nP, mP_pars, eP, 
                       nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi){
  
  # assign the initial upper and lower phi values
  left <- left0
  right <- right0
  
  # areas for calculating total area occupied
  Amax <- pi*(1/2*G_pars$Dinf)^2
  Amin <- pi*(1/2*G_pars$Dmin)^2
  A12 <- F_pars$Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class assuming uniform distributions)
  A <- c((Amin + A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  
  # starting vectors for adding results of test for equilibration each iteration of the while loop
  eq_check.1 <- c(0)
  eq_check.2 <- c(0)
  
  while(right-left > error_tol){ # while the difference btw the upper and lower values is 
    # greater than the error tolerance
    
    # calculate the midpoints
    # ternary search algorithm so divide range into thirds
    mid1 <- left + (right-left)/3 # add 1/3 of the range
    mid2 <- right - (right-left)/3 # subtract 1/3 of the range
    
    # run the model with phi = mid1 and mid2
    
    sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                         eH, Apatch, z, phi = mid1)
    Ptot1 <- sum(sim1$P[,tmax])
    Htot1 <- sum(sim1$H[,tmax])
    HAtot1 <- sum(sim1$H[,tmax]*A)
    
    P_all1 <- sim1$P[,tmax]
    H_all1 <- sim1$H[,tmax]
    
    sim2 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi = mid2)
    Ptot2 <- sum(sim2$P[,tmax])
    
    if(Ptot1 > Ptot2){ # if P abundance at the value to the left is greater than at the value to the right
      right <- mid2 # the max is to the left so make the rightmost point the right midpoint
    } else{
      left <- mid1 # otherwise the max is to the right so make the leftmost point the left midpoint
    }
    
    propH <- abs((sum(sim1$H[,tmax])-sum(sim1$H[,tmax-10]))/sum(sim1$H[,tmax-10]))
    Heq1 <- ifelse(propH > eqtol, 1, 0)
    
    propP <- abs((sum(sim1$P[,tmax])-sum(sim1$P[,tmax-10]))/sum(sim1$P[,tmax-10]))
    Peq1 <- ifelse(propP > eqtol, 1, 0)
    
    propH <- abs((sum(sim2$H[,tmax])-sum(sim2$H[,tmax-10]))/sum(sim2$H[,tmax-10]))
    Heq2 <- ifelse(propH > eqtol, 1, 0)
    
    propP <- abs((sum(sim2$P[,tmax])-sum(sim2$P[,tmax-10]))/sum(sim2$P[,tmax-10]))
    Peq2 <- ifelse(propP > eqtol, 1, 0)
    
    eq_check1 <- Heq1 + Peq1 # 0 if both equilibrated, 1 if one, 2 if neither
    eq_check2 <- Heq2 + Peq2
    
    # also check the system equilibrated
    eq_check.1 <- c(eq_check1, eq_check.1)
    eq_check.2 <- c(eq_check2, eq_check.2)
    
  }
  
  
  
  return(list(phi = mid1, P = Ptot1, HA = HAtot1, H = Htot1, P_all = P_all1, H_all = H_all1,
              eq_check.1 = eq_check.1, eq_check.2 = eq_check.2)) # return the midpoint and P and H abundances at the midpoint and the checks for equilibration
  
}


# ternary search algorithm for finding the ecological optimum phi value based on max host (not partner) cover
# left0 = initial leftmost value of phi
# right0 = initial rightmost value of phi
# error_tol = error tolerance for optimum value
# eqtol = tolerance level for whether model has equilibrated (prop difference btw abundance at time tmax and time tmax-10)

phiTSA_H_fun <- function(left0, right0, error_tol, eqtol, tmax, P0, H0, rP, nP, mP_pars, eP, 
                       nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi){
  
  # assign the initial upper and lower phi values
  left <- left0
  right <- right0
  
  # areas for calculating total area occupied
  Amax <- pi*(1/2*G_pars$Dinf)^2
  Amin <- pi*(1/2*G_pars$Dmin)^2
  A12 <- F_pars$Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class)
  A <- c((Amin + A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  # starting vectors for equilibration checks
  eq_check.1 <- c(0)
  eq_check.2 <- c(0)
  
  while(right-left > error_tol){ # while the difference btw the upper and lower values is 
    # greater than the error tolerance
    
    # calculate the midpoints
    # ternary search algorithm so divide range into thirds
    mid1 <- left + (right-left)/3 # add 1/3 of the range
    mid2 <- right - (right-left)/3 # subtract 1/3 of the range
    
    # run the model with phi = mid1 and mid2
    
    sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi = mid1)
    Ptot1 <- sum(sim1$P[,tmax])
    Htot1 <- sum(sim1$H[,tmax])
    HAtot1 <- sum(sim1$H[,tmax]*A)
    
    P_all1 <- sim1$P[,tmax]
    H_all1 <- sim1$H[,tmax]
    
    sim2 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi = mid2)
    Ptot2 <- sum(sim2$P[,tmax])
    HAtot2 <- sum(sim2$H[,tmax]*A)
    
    if(HAtot1 > HAtot2){ # if H cover at the value to the left is greater than at the value to the right
      right <- mid2 # the max is to the left so make the rightmost point the right midpoint
    } else{
      left <- mid1 # otherwise the max is to the right so make the leftmost point the left midpoint
    }
    
    propH <- abs((sum(sim1$H[,tmax])-sum(sim1$H[,tmax-10]))/sum(sim1$H[,tmax-10]))
    Heq1 <- ifelse(propH > eqtol, 1, 0)
    
    propP <- abs((sum(sim1$P[,tmax])-sum(sim1$P[,tmax-10]))/sum(sim1$P[,tmax-10]))
    Peq1 <- ifelse(propP > eqtol, 1, 0)
    
    propH <- abs((sum(sim2$H[,tmax])-sum(sim2$H[,tmax-10]))/sum(sim2$H[,tmax-10]))
    Heq2 <- ifelse(propH > eqtol, 1, 0)
    
    propP <- abs((sum(sim2$P[,tmax])-sum(sim2$P[,tmax-10]))/sum(sim2$P[,tmax-10]))
    Peq2 <- ifelse(propP > eqtol, 1, 0)
    
    eq_check1 <- Heq1 + Peq1 # 0 if both equilibrated, 1 if one, 2 if neither
    eq_check2 <- Heq2 + Peq2
    
    # also check the system equilibrated
    eq_check.1 <- c(eq_check1, eq_check.1)
    eq_check.2 <- c(eq_check2, eq_check.2)
    
  }
  
  
  
  return(list(phi = mid1, P = Ptot1, HA = HAtot1, H = Htot1, P_all = P_all1, H_all = H_all1,
              eq_check.1 = eq_check.1, eq_check.2 = eq_check.2)) 
  
}



################ EVOLUTION FUNCTIONS ######################
# model function with Resident and Invader partner populations
# tmax = max timepoint in simulation
# R0 = initial resident partner population densities on each host size class (vector)
# I0 = initial invader partner population densities on each host size class (vector)
# H0 = initial host densities in each size class (vector)
# rP = partner reproduction rate (same on all host size classes)
# nP = partner density independent mortality rate (same on all host size classes)
# mP_pars = parameters for relationship btw partner density dependent mortality rates and host area (named list with parameters slope_mP and K0)
# eP = partner external recruitment
# phi = values of the phi trait (strength of preference for larger hosts/prop of larvae that ignore smallest hosts), NOTE in this function phi is a vector where 1st element = resident phi and 2nd element = invader phi
# nH_pars = parameters for calculating host density independent mortality rates as a function  of partner abundance (named list with elements a_n, b_n, c_n0, exp_cn, and cn_mx)
# mH_pars = parameters for calculating host density dep mortality (named list with elements a_m, b_m, and c_m)
# G_pars = parameters for calculating host growth rates as a function of partner abundance (named list with elements Dinf, g0, exp_g, and g_mx)
# F_pars = parameters for calculating host fecundities (named list with elements Fmn, Fconst, Fexp)
# eH = host external recruitment
# Apatch = total patch area (carrying capacity for the host)
# z determines whether the system is open (0) or closed (1)


RImod_fun <- function(tmax, R0, I0, H0, rP, nP, mP_pars, eP, phi, nH_pars, mH_pars, G_pars, 
                      F_pars, eH, Apatch, z){
  
  
  # unlist parameters
  # partner DD mortality
  K0 <- mP_pars$K0; slope_mP <- mP_pars$slope_mP
  
  # host dens-indep mortality
  a_n <- nH_pars$a_n; b_n <- nH_pars$b_n; c_n0 <- nH_pars$c_n0; exp_cn <- nH_pars$exp_cn; cn_mn <- nH_pars$cn_mn
  
  # host density dep mortality
  a_m <- mH_pars$a_m; b_m <- mH_pars$b_m; c_m <- mH_pars$c_m
  
  # host growth
  Dinf <- G_pars$Dinf; g0 <- G_pars$g0; exp_g <- G_pars$exp_g; g_mx <- G_pars$g_mx
  Dmin <- G_pars$Dmin
  
  # host fecundity
  Fmn <- F_pars$Fmn; Fconst <- F_pars$Fconst; Fexp <- F_pars$Fexp
  
  # calculate fixed parameters
  # boundaries of the host size classes: 0-Fmn, Fmn-90% of max size, >90% of max size
  Amax <- pi*(1/2*Dinf)^2
  Amin <- pi*(1/2*Dmin)^2
  A12 <- Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class)
  A <- c((Amin+A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  # partner density dependent mortality in each size class (depend on areas in each class)
  mP <- c(avg_Pmort(Amin, A12, K0, slope_mP), avg_Pmort(A12, A23, K0, slope_mP), avg_Pmort(A23, Amax, K0, slope_mP))
  
  # host fecundities in each size class
  FH <- c(0, avg_fec(A12, A23, Fmn, Fconst, Fexp), avg_fec(A23, Amax, Fmn, Fconst, Fexp))
  
  # host density dependent mortality rates in each size class
  mH <- c(avg_mort(Amin, A12, a_m, b_m, c_m), avg_mort(A12, A23, a_m, b_m, c_m), avg_mort(A23, Amax, a_m, b_m, c_m))
  
  # vector of time steps
  tset <- seq(from = 0, to = tmax, by = 1) # time steps for iterating over
  
  # holding matrices and initial conditions
  # host
  Hmat <- matrix(NA, nrow = length(A), ncol = length(tset))
  Hmat[ ,1] <- H0
  
  # partner (resident)
  Rmat <- matrix(NA, nrow = length(A), ncol = length(tset))
  Rmat[ ,1] <- R0
  
  # partner (invader)
  Imat <- matrix(NA, nrow = length(A), ncol = length(tset))
  Imat[ ,1] <- I0
  
  
  for(i in 2:length(tset)){ # for each timepoint
    
    # calculate the area occupied
    Atot <- sum(A*Hmat[, i-1])
    
    # calculate the host growth rates as a function of P per unit host
    g_i <- GofP(g0, exp_g, g_mx, (Rmat[, i-1] + Imat[, i-1])/Hmat[, i-1])
    
    # calculate size class transitions
    # class 1 to 2:
    A0_1 <- S1ofA(A12, Dinf, g_i[1])
    G12 <- ifelse(A0_1 < Amin, 1, (A12-A0_1)/(A12-Amin)) # proportion that grew into next size class; if area at previous timestep is less than Amin, say 100% of class 1 grew to class 2
    
    # class 2 to 3: 
    A0_2 <- S1ofA(A23, Dinf, g_i[2])
    G23 <- ifelse(A0_2 < A12, 1, (A23-A0_2)/(A23-A12)) # proportion that grew into next size class; if area at previous timestep is in size class 1 (A02 < A12), say 100% of class 2 grew to class 3
    
    G <- c(G12, G23, 0)
    
    # calculate host dens-indep mortality rates as a function of total P (sum of R and I) per host
    c_n <- MofP(c_n0, exp_cn, cn_mn, (Rmat[, i-1] + Imat[, i-1])/Hmat[, i-1])
    nH <- c(avg_mort(Amin, A12, a_n, b_n, c_n[1]), avg_mort(A12, A23, a_n, b_n, c_n[2]), avg_mort(A23, Amax, a_n, b_n, c_n[3]))
    
    # calculate the host growth and survival rates
    G_Ht <- G*max(0, 1-Atot/Apatch) # realized growth depends on how much room there is
    S_Ht <- exp(-(nH + mH*Atot/Apatch)) 
    
    # calculate the survival rates for the partner
    S_P <- rep(NA, 3)
    
    for(sss in 1:3){
      if(Hmat[sss,i-1] == 0){
        S_P[sss] <- 0
      } else{
        S_P[sss] <- exp(-(nP + mP[sss]*(Rmat[sss, i-1] + Imat[sss, i-1])/Hmat[sss,i-1])) # mortality depends on P/H
      }
    }
    
    # make the host transition matrix
    T_H <- matrix(rep(0, length(S_Ht)^2), nrow = length(S_Ht), ncol = length(S_Ht))
    # fill in the first row (note fecundities are done separately below)
    T_H[1, 1] <- (1-G_Ht[1])*S_Ht[1]
    
    # make the fish transition matrix
    T_P <- matrix(rep(0, length(S_Ht)^2), nrow = length(S_Ht), ncol = length(S_Ht))
    # fill in the first row
    T_P[1, 1] <- (1-G_Ht[1])*S_P[1]*S_Ht[1]
    
    
    # fill in the rest
    for(mm in 2:length(S_Ht)){
      
      # host
      T_H[mm, mm] <- (1-G_Ht[mm])*S_Ht[mm] # surviving and staying put
      T_H[mm, mm-1] <- G_Ht[mm-1]*S_Ht[mm-1] # surviving and growing to next size class
      
      # partner (same for resident and invader)
      T_P[mm, mm] <- (1-G_Ht[mm])*S_P[mm]*S_Ht[mm] # surviving and staying put
      T_P[mm, mm-1] <- G_Ht[mm-1]*S_P[mm-1]*S_Ht[mm-1] # surviving and growing to next size class
    }
    
    # calculate the new population sizes
    Hmat[, i] <- T_H %*% Hmat[, i-1]
    Rmat[, i] <- T_P %*% Rmat[, i-1]
    Imat[, i] <- T_P %*% Imat[, i-1]
    
    
    
    # new recruits for the partner: distribute across the size classes according to preference function
    # total recruits (depends on whether population is open or closed)
    RRtot <- z*sum(rP*Rmat[ ,i-1]) + (1-z)*eP # resident recruits
    
    IRtot <- z*sum(rP*Imat[ ,i-1]) + (1-z)*eP # invader recruits
    
    # preferences
    
    if(sum(Hmat[, i-1])==0){ # if there are no hosts
      pxset1 <- c(0, 0, 0)
      pxset2 <- c(0, 0, 0) 
    } else{
      
      pxset1 <- phi_fun(phi[1], A*Hmat[, i-1]) # resident
      pxset2 <- phi_fun(phi[2], A*Hmat[, i-1]) # invader
      
    } 
    
    # calculate recruit survival
    S_R <- rep(NA, 3)
    
    for(sss in 1:3){
      if(Hmat[sss,i-1] == 0){ # index here needs to match index used for P/H (i or i-1)
        S_R[sss] <- 0
      } else{
        S_R[sss] <- exp(-(nP + mP[sss]*(Rmat[sss, i-1] + Imat[sss, i-1])/Hmat[sss, i-1]))
      }
    }
    
    # add new recruits 
    Rmat[, i] <- Rmat[, i] +  pxset1*RRtot*S_R 
    Imat[, i] <- Imat[, i] +  pxset2*IRtot*S_R 
    
    # add new recruits for the host 
    Hmat[1, i] <- Hmat[1, i] + z*sum(FH*Hmat[ ,i-1])*max(0, 1-Atot/Apatch) + (1-z)*eH*max(0, 1-Atot/Apatch)
    
    
    
    
  }
  
  
  
  return(list(t = tset, H = Hmat, R = Rmat, I = Imat))
  
}


# simple adaptive dynamics function
# n_mut = number of mutation events to simulate
# t_r = length of time to run model for calculating invader's growth rate (must be an even number for growth rate calculations)
# mut_size = size of each mutation
# tmax = length of time to run model for calculating equilibrium R and H abundances 
# rest of parameters are as for RImod_fun. R0 and H0 are for the initial simulation to get the equilibrium R and H abundances before any mutations start, and I0 is the initial abundance  of the invader for the invasion simulations. phi is the initial phi values of the resident (1) and invader (2), but initial phiI doesn't matter
# eqtol = tolerance level for whether model has equilibrated (prop difference btw abundance at time tmax and time tmax-10)

AD_fun2 <- function(n_mut, t_r, mut_size, tmax, R0, I0, H0, rP, nP, mP_pars, eP, phi, 
                   nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, eqtol){
  
  # areas for calculating equilibrium host area
  # boundaries of the host size classes: 0-Fmn, Fmn-90% of max size, >90% of max size
  Dinf <- G_pars$Dinf
  Dmin <- G_pars$Dmin
  Fmn <- F_pars$Fmn
  Amax <- pi*(1/2*Dinf)^2
  Amin <- pi*(1/2*Dmin)^2
  A12 <- Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class)
  A <- c((Amin+A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  # holding vectors and matrices
  phiR_set <- rep(NA, n_mut) # vector of values for evolving trait
  phiR_set[1] <- phi[1] # initial phi value for resident population
  
  # equilibrium resident and host population sizes (pre-invasion)
  Heqs <- matrix(NA, nrow = n_mut, ncol = 6) # total area, total number, H1, H2, H3, eq check
  Reqs <- matrix(NA, nrow = n_mut, ncol = 5) # total, R1, R2, R3, eq check
  
  growth_check <- rep(NA, n_mut) # for checking whether both mutants grew
  
  
  # get the first equilibrium without any invaders
  sim0 <- RImod_fun(tmax, R0, I0 = c(0,0,0), H0, rP, nP, mP_pars, eP, phi, nH_pars, mH_pars,
                    G_pars, F_pars, eH, Apatch, z)
  
  Heqs[1, 1:5] <- c(sum(sim0$H[,tmax]*A), sum(sim0$H[,tmax]), sim0$H[1,tmax], sim0$H[2,tmax], sim0$H[3,tmax])
  propH <- abs((sum(sim0$H[,tmax])-sum(sim0$H[,tmax-10]))/sum(sim0$H[,tmax-10]))
  Heqs[1, 6] <- ifelse(propH > eqtol, 1, 0)
  
  Reqs[1, 1:4] <- c(sum(sim0$R[,tmax]), sim0$R[1,tmax], sim0$R[2,tmax], sim0$R[3,tmax])
  propP <- abs((sum(sim0$R[,tmax])-sum(sim0$R[,tmax-10]))/sum(sim0$R[,tmax-10]))
  Reqs[1, 5] <- ifelse(propP > eqtol, 1, 0)
  
  for(i in 2:n_mut){ # for each mutation event
    
    # first get the equilibrium value of the (i-1)^th resident population (pre-invasion)
    # use Heqs[i-1, 3:5] and Reqs[i-1, 2:4] as the initial conditions - should be close to new eq
    sim0 <- RImod_fun(tmax, R0 = Reqs[i-1, 2:4], I0 = c(0,0,0), H0 = Heqs[i-1, 3:5], rP, nP,
                      mP_pars, eP, phi = c(phiR_set[i-1], phiR_set[i-1]), nH_pars, mH_pars, 
                      G_pars, F_pars, eH, Apatch, z)
    
    # store the new equilibrium values
    Heqs[i, 1:5] <- c(sum(sim0$H[,tmax]*A), sum(sim0$H[,tmax]), sim0$H[1,tmax], sim0$H[2,tmax], sim0$H[3,tmax])
    
    # check for equilibration
    propH <- abs((sum(sim0$H[,tmax])-sum(sim0$H[,tmax-10]))/sum(sim0$H[,tmax-10]))
    Heqs[i, 6] <- ifelse(propH > eqtol, 1, 0)
    
    # repeat for resident partners
    Reqs[i, 1:4] <- c(sum(sim0$R[,tmax]), sim0$R[1,tmax], sim0$R[2,tmax], sim0$R[3,tmax])
    propP <- abs((sum(sim0$R[,tmax])-sum(sim0$R[,tmax-10]))/sum(sim0$R[,tmax-10]))
    Reqs[i, 5] <- ifelse(propP > eqtol, 1, 0)
    
    # now introduce the two mutants
    phiI.1 <- max(0, phiR_set[i-1] - mut_size) # larger phi than resident
    phiI.2 <- min(phiR_set[i-1] + mut_size, 1) # smaller phi than resident
    
    # run simulations where each invades
    # use Heqs[i, 3:5] and Reqs[i, 2:4] as the initial conditions
    # phi = c(phiR_set[i-1], phiI.1) or c(phiR_set[i-1], phiI.2)
    sim_m1 <- RImod_fun(t_r, R0 = Reqs[i, 2:4], I0, H0 = Heqs[i, 3:5], rP, nP,
                        mP_pars, eP, phi = c(phiR_set[i-1], phiI.1), nH_pars, mH_pars,
                        G_pars, F_pars, eH, Apatch, z)
    
    sim_m2 <- RImod_fun(t_r, R0 = Reqs[i, 2:4], I0, H0 = Heqs[i, 3:5], rP, nP, 
                        mP_pars, eP, phi = c(phiR_set[i-1], phiI.2), nH_pars, mH_pars, 
                        G_pars, F_pars, eH, Apatch, z)
    
    # calculate the growth rates of the invaders based on change in total (across all host size classes) population sizes
    Itot.1 <- sim_m1$I[1,] + sim_m1$I[2,] + sim_m1$I[3,]
    Itot.2 <- sim_m2$I[1,] + sim_m2$I[2,] + sim_m2$I[3,]
    
    s.1 <- (Itot.1[t_r]-Itot.1[t_r-0.5*t_r])/Itot.1[t_r-0.5*t_r]
    s.2 <- (Itot.2[t_r]-Itot.2[t_r-0.5*t_r])/Itot.2[t_r-0.5*t_r]
    
    # determine which mutant fixes
    if(s.1 <= 0 && s.2 <= 0){ # if neither mutant grew
      phiR_set[i] <- phiR_set[i-1] # the resident trait doesn't change
      break # break the loop
      
    } else{ # if one of the mututants grew
      
      if(s.2 > s.1){ # if mutant 2's growth rate was higher
        # mutant 2 is the new resident trait
        phiR_set[i] <- phiI.2
      }
      
      if(s.1 > s.2){ # if mutant 1's growth rate was higher
        # mutant 1 is the new resident trait
        phiR_set[i] <- phiI.1
      }
      
      # check to see if both mutants grew
      if(s.1 > 0 && s.2 > 0){
        
        growth_check[i] <- s.1/s.2
        
      }
        
    }
    
    
  }
  
  
  return(list(phiR = phiR_set, Heqs = Heqs, Reqs = Reqs, growth_check = growth_check))
  
}


# function for making a pairwise invasion plot
# phi_set = set of phi values that will be compared against each other
# t_r = length of time to run model for calculating invader's growth rate (must be an even number for growth rate calculations)
# tmax = length of time to run model for calculating equilibrium R and H abundances 
# eqtol = tolerance level for whether model has equilibrated (prop difference btw abundance at time tmax and time tmax-10)

# rest of parameters are as for RImod_fun. R0 and H0 are for the initial simulation to get the equilibrium R and H abundances before any mutations start, and I0 is the initial abundance  of the invader for the invasion simulations. phi is the initial phi values of the resident (1) and invader (2), but initial phiI doesn't matter

PIP_fun <- function(phi_set, t_r, tmax, R0, I0, H0, rP, nP, mP_pars, eP, phi, 
                    nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, eqtol){
  
  
  # areas for calculating equilibrium host area
  # boundaries of the host size classes: 0-Fmn, Fmn-90% of max size, >90% of max size
  Dinf <- G_pars$Dinf
  Dmin <- G_pars$Dmin
  Fmn <- F_pars$Fmn
  Amax <- pi*(1/2*Dinf)^2
  Amin <- pi*(1/2*Dmin)^2
  A12 <- Fmn
  A23 <- 0.9*Amax
  
  # midpoints (used for calculating area occupied by each class; same as avg area in each class)
  A <- c((Amin+A12)/2, (A23+A12)/2, (Amax+A23)/2)
  
  # holding vectors and matrices
  inv_mat <- matrix(NA, nrow = length(phi_set), ncol = length(phi_set)) # invasion matrix (1 = mutant fixes, 0 = mutant unable to invade)
  

  # get the first equilibrium for reference
  sim0 <- RImod_fun(tmax, R0, I0 = c(0,0,0), H0, rP, nP, mP_pars, eP, phi = c(0.5, 0.5), nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z)
  
  H_ref <- sim0$H[,tmax]
  R_ref <- sim0$R[,tmax]
  
  
  for(i in 1:length(phi_set)){ # for each resident phi
    
    for(j in 1:length(phi_set)){ # for each mutant phi
      
      # first get the equilibrium value of the resident population (pre-invasion)
      
      sim0 <- RImod_fun(tmax, R0 = R_ref, I0 = c(0,0,0), H0 = H_ref, rP, nP, 
                        mP_pars, eP, phi = c(phi_set[i], phi_set[i]), nH_pars, mH_pars, 
                        G_pars, F_pars, eH, Apatch, z)
      
      # store the equilibrium values
      H_eqs <- sim0$H[,tmax]
      R_eqs <- sim0$R[,tmax]
      
      # now introduce the mutant and run simulations where the mutant invades
      sim_m1 <- RImod_fun(t_r, R0 = R_eqs, I0, H0 = H_eqs, rP, nP,
                          mP_pars, eP, phi = c(phi_set[i], phi_set[j]), nH_pars, mH_pars,
                          G_pars, F_pars, eH, Apatch, z)
      
      # calculate the growth rate of the invader
      Itot.1 <- sim_m1$I[1,] + sim_m1$I[2,] + sim_m1$I[3,]
      s.1 <- (Itot.1[t_r]-Itot.1[t_r-0.5*t_r])/Itot.1[t_r-0.5*t_r]
      
      # determine if the mutant will invade
      if(s.1 > 0){
        inv_mat[i,j] <- 1
      } else{
        inv_mat[i,j] <- 0
      }
      
    } 
    
    
  }
  
  
  return(list(inv_mat = inv_mat))
  
}




############## SIMULATION FUNCTIONS ###################
# function for calculating biomass-maximizing and ESS values of phi as a function of model parameters
# par_choice = parameter to vary ("exp_g", "exp_cn", "g0", "Fconst", "c_n0", or "rP")
# par_set = set of values of the par_choice parameter to iterate over

EcoEvo_fun <- function(par_choice, par_set, tmax, P0, H0, I0, rP, nP, mP_pars, eP, nH_pars,
                       mH_pars, G_pars, F_pars, eH, Apatch, z, phi, phiRI){
  
  # holding vectors for the phi values
  eco_phi <- rep(NA, length(par_set))
  evo_phi <- rep(NA, length(par_set))
  
  # holding vectors for equilibration checks
  eco_eq <- rep(NA, length(par_set))
  evo_eq <- rep(NA, length(par_set))
  
  # holding vector for evo mutant growth checks
  evo_growth <- rep(NA, length(par_set))
  
  # holding lists for full outputs
  eco_list <- list()
  evo_list <- list()
  
  for(i in 1:length(par_set)){ # for each element of par_set
    
    # determine which parameter value to change
    if(par_choice == "exp_g"){
      G_pars$exp_g <- par_set[i]
    }
    
    if(par_choice == "exp_cn"){
      nH_pars$exp_cn <- par_set[i]
    }
    
    if(par_choice == "g0"){
      G_pars$g0 <- par_set[i]
    }
    
    if(par_choice == "Fconst"){
      F_pars$Fconst <- par_set[i]
    }
    
    if(par_choice == "c_n0"){
      nH_pars$c_n0 <- par_set[i]
      nH_pars$a_n <- ac_mult*c_n0
    }
    
    if(par_choice == "rP"){
      rP <- par_set[i]
    }
    
    
    # eco sim
    
    # first get initial conditions (equilibrium with phi = 0.5)
    sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi = 0.5)
    
    P0.5 <- sim1$P[,tmax]
    H0.5 <- sim1$H[,tmax]
    
    # calculate the optimum phi value
    eco_opt <- phiTSA_fun(left0, right0, error_tol, eqtol, tmax, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi)
    
    eco_list[[i]] <- eco_opt
    eco_phi[i] <- eco_opt$phi
    eco_eq[i] <- sum(eco_opt$eq_check.1, eco_opt$eq_check.2)
    
    # evo sim
    evo_ess <- AD_fun2(n_mut, t_r, mut_size, tmax, R0 = P0, I0, H0, rP, nP, mP_pars, eP, 
                       phi = phiRI, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, eqtol)
    
    evo_list[[i]] <- evo_ess
    evo_eq[i] <- sum(evo_ess$Heqs[,6], evo_ess$Reqs[,5])
    evo_growth[i] <- length(which(is.na(evo_ess$growth_check)==F))
    
    # can't just record final phi value in evo sims if it is bouncing around between two values (the true ESS can't be reached because the mutation size is too large) so need an if else statement: if last entry is NA, it reached stable value so use the last nonNA value, if not, check if bouncing and record mean (upper and lower will be mean +- mut_size), otherwise flag bc ess was not reached (use -9999)
    
    if(is.na(evo_ess$phiR[n_mut]) == T){ # if last entry is NA, then stable value was reached before last mutation
      evo_phi[i] <- evo_ess$phiR[max(which(is.na(evo_ess$phiR)==F))]
    } else{
      
      if(length(unique(evo_ess$phiR[(n_mut-3):n_mut])) == 2){ # if bouncing btw two values, the last 4 entries should contain only 2 unique values
        
        evo_phi[i] <- mean(c(evo_ess$phiR[n_mut], evo_ess$phiR[n_mut-1]))
      } else{
        
        evo_phi[i] <- -9999
      }
      
    }
    
  }
  
  return(list(eco_list = eco_list, eco_phi = eco_phi, eco_eq = eco_eq, evo_list = evo_list,
              evo_phi = evo_phi, evo_eq = evo_eq, evo_growth = evo_growth))
  
}


# function for calculating host cover maximizing values of phi as a function of model pars
# par_choice = parameter to vary ("exp_g", "exp_cn", "g0", "Fconst", "c_n0", or "rP")
# par_set = set of values of the par_choice parameter to iterate over

EcoH_fun <- function(par_choice, par_set, tmax, P0, H0, I0, rP, nP, mP_pars, eP, nH_pars,
                       mH_pars, G_pars, F_pars, eH, Apatch, z, phi, phiRI){
  
  # holding vectors for the phi values
  eco_phi <- rep(NA, length(par_set))
  
  # holding vectors for equilibration checks
  eco_eq <- rep(NA, length(par_set))
  
  # holding lists for full outputs
  eco_list <- list()
  
  for(i in 1:length(par_set)){ # for each element in par_set
    
    # determine which parameter value to change
    if(par_choice == "exp_g"){
      G_pars$exp_g <- par_set[i]
    }
    
    if(par_choice == "exp_cn"){
      nH_pars$exp_cn <- par_set[i]
    }
    
    if(par_choice == "g0"){
      G_pars$g0 <- par_set[i]
    }
    
    if(par_choice == "Fconst"){
      F_pars$Fconst <- par_set[i]
    }
    
    if(par_choice == "c_n0"){
      nH_pars$c_n0 <- par_set[i]
      nH_pars$a_n <- ac_mult*c_n0
    }
    
    if(par_choice == "rP"){
      rP <- par_set[i]
    }
    
    
    # eco sim
    
    # first get initial conditions (equilibrium with phi = 0.5)
    sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, 
                     eH, Apatch, z, phi = 0.5)
    
    P0.5 <- sim1$P[,tmax]
    H0.5 <- sim1$H[,tmax]
    
    # calculate the optimum phi value
    eco_opt <- phiTSA_H_fun(left0, right0, error_tol, eqtol, tmax, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi)
    
    eco_list[[i]] <- eco_opt
    eco_phi[i] <- eco_opt$phi
    eco_eq[i] <- sum(eco_opt$eq_check.1, eco_opt$eq_check.2)
    
    
  }
  
  return(list(eco_list = eco_list, eco_phi = eco_phi, eco_eq = eco_eq))
  
}


# full function for calculating partner-maximizing and ESS values of phi as a function of any model parameter (for full sensitivity analysis of model parameters)
# psens = named list with parameters for which to test model sensitivity 
# x = proportional increase and decrease in each parameter in psens for sensitivity analysis

EcoEvoSens_fun <- function(psens, x, tmax, P0, H0, I0, rP, nP, mP_pars, eP, nH_pars,
                       mH_pars, G_pars, F_pars, eH, Apatch, z, phi, phiRI){
  
  
  # holding matrices for the phi values
  eco_phi <- matrix(NA, nrow = length(psens), ncol = 3) # cols = decrease, default, increase
  evo_phi <- matrix(NA, nrow = length(psens), ncol = 3)
  
  # holding vectors for equilibration checks
  eco_eq <- matrix(NA, nrow = length(psens), ncol = 3)
  evo_eq <- matrix(NA, nrow = length(psens), ncol = 3)
  
  # holding vector for evo mutant growth checks
  evo_growth <- matrix(NA, nrow = length(psens), ncol = 3)
  
  # holding lists for full outputs
  eco_list_full <- list()
  evo_list_full <- list()
  
  for(j in 1:length(psens)){ # for each parameter in psens
  #for(j in 1:2){
    
    # holding lists for outputs of eco and evo simulations
    eco_list <- list()
    evo_list <- list()
    
    # get the parameter set
    par_set <- c(psens[[j]]-x*psens[[j]], psens[[j]], psens[[j]] + psens[[j]]*x)
    
    for(i in 1:length(par_set)){
      
      # update all the parameter values
      psens2 <- psens
      psens2[[j]] <- par_set[i]
      
      #psens <- list(rP = rP, nP = nP, K0 = K0, a_n = a_n, b_n = b_n, c_n0 = c_n0, 
      #cn_mn = cn_mn, a_m = a_m, b_m = b_m, c_m = c_m, g0 = g0, g_mx = g_mx, Fmn = Fmn, 
      #Fconst = Fconst, Fexp = Fexp, Apatch = Apatch)
      rP <- psens2$rP; nP <- psens2$nP; K0 <- psens2$K0; a_n <- psens2$a_n; b_n <- psens2$b_n
      c_n0 <- psens2$c_n0; cn_mn <- psens2$cn_mn; a_m <- psens2$a_m; b_m <- psens2$b_m
      c_m <- psens2$c_m; g0 <- psens2$g0; g_mx <- psens2$g_mx; Fmn <- psens2$Fmn
      Fconst <- psens2$Fconst; Fexp <- psens2$Fexp; Apatch <- psens2$Apatch
      
      mP_pars1 <- mP_pars
      G_pars1 <- G_pars
      nH_pars1 <- nH_pars
      mH_pars1 <- mH_pars
      F_pars1 <- F_pars
      
      mP_pars1$K0 <- K0
      
      nH_pars1$a_n <- a_n
      nH_pars1$b_n <- b_n
      nH_pars1$c_n0 <- c_n0
      nH_pars1$cn_mn <- cn_mn
      
      mH_pars1$a_m <- a_m
      mH_pars1$b_m <- b_m
      mH_pars1$c_m <- c_m
      
      G_pars1$g0 <- g0
      G_pars1$g_mx <- g_mx
     
      F_pars1$Fmn <- Fmn
      F_pars1$Fconst <- Fconst
      F_pars1$Fexp <- Fexp
      
      
      # eco sim
      
      # first get initial conditions (equilibrium with phi = 0.5)
      sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars1, eP, nH_pars1, mH_pars1, G_pars1, F_pars1, eH, Apatch, z, phi = 0.5)
      
      P0.5 <- sim1$P[,tmax]
      H0.5 <- sim1$H[,tmax]
      
      # calculate the optimum phi value
      eco_opt <- phiTSA_fun(left0, right0, error_tol, eqtol, 0.5*tmax, P0.5, H0.5, rP, nP, 
                            mP_pars1, eP, nH_pars1, mH_pars1, G_pars1, F_pars1, eH, Apatch, 
                            z, phi)
      
      eco_list[[i]] <- eco_opt
      eco_phi[j, i] <- eco_opt$phi
      eco_eq[j, i] <- sum(eco_opt$eq_check.1, eco_opt$eq_check.2)
      
      # evo sims
      evo_ess <- AD_fun2(n_mut, t_r, mut_size, 0.5*tmax, R0 = P0, I0, H0, rP, nP, mP_pars1, 
                         eP, phi = phiRI, nH_pars1, mH_pars1, G_pars1, F_pars1, eH, Apatch, z, eqtol)
      
      evo_list[[i]] <- evo_ess
      evo_eq[j, i] <- sum(evo_ess$Heqs[,6], evo_ess$Reqs[,5])
      evo_growth[j, i] <- length(which(is.na(evo_ess$growth_check)==F))
      
      if(is.na(evo_ess$phiR[n_mut]) == T){ # if last entry is NA, then stable value was reached before last mutation
        evo_phi[j, i] <- evo_ess$phiR[max(which(is.na(evo_ess$phiR)==F))]
      } else{
        
        if(length(unique(evo_ess$phiR[(n_mut-3):n_mut])) == 2){ # if bouncing btw two values, the last 4 entries should contain only 2 unique values
          
          evo_phi[j, i] <- mean(c(evo_ess$phiR[n_mut], evo_ess$phiR[n_mut-1]))
        } else{
          
          evo_phi[j, i] <- -9999
        }
        
      }
      
    }
    
    eco_list_full[[j]] <- eco_list
    evo_list_full[[j]] <- evo_list
    
  }
  
  
  
  
  
  return(list(eco_list_full = eco_list_full, eco_phi = eco_phi, eco_eq = eco_eq, evo_list_full = evo_list_full,
              evo_phi = evo_phi, evo_eq = evo_eq, evo_growth = evo_growth))
  
}


# function for testing sensitivity of model equilibria to each parameter (just ecological timescales)
# tmax = max timepoint in simulation
# P0 = initial partner population densities on each host size class (vector)
# H0 = initial host densities in each size class (vector)
# plist = named list with the name and values of all model parameters (includes a vector of values for the parameter to evaluate sensitivity)
# eqtol = tolerance level for whether model has equilibrated (prop difference btw abundance at time tmax and time tmax-10)
# change_a = whether a should change with c (mortality of host with area of 0 is a + c)

sens_fun <- function(tmax, P0, H0, plist, eqtol, change_a = TRUE){
  
  # first find the parameter set to iterate over (element of plist that has a length > 1)
  elem_length <- rep(NA, length(plist))
  
  for(ll in 1:length(elem_length)){
    elem_length[ll] <- length(plist[[ll]])
  }
  
  
  pset <- plist[[which(elem_length>1)]]
  
  # holding matrix for the simulations
  Heq1 <- matrix(NA, nrow = length(pset), ncol = 6) # columns: total area, total, each class, and eqcheck
  Peq1 <- matrix(NA, nrow = length(pset), ncol = 5) # columns: total, each class, and eqcheck
  
  HFeq1 <- rep(NA, length(pset)) # total reproductive output
  
  for(i in 1:length(pset)){
    
    
    # set up the parameters
    rP <- ifelse(length(plist$rP)== 1, plist$rP, pset[i])
    nP <- ifelse(length(plist$nP)== 1, plist$nP, pset[i])
    K0 <- ifelse(length(plist$K0)== 1, plist$K0, pset[i])
    slope_mP <- ifelse(length(plist$slope_mP)== 1, plist$slope_mP, pset[i])
    eP <- ifelse(length(plist$eP)== 1, plist$eP, pset[i])
    
    a_n <- ifelse(length(plist$a_n)== 1, plist$a_n, pset[i])
    b_n <- ifelse(length(plist$b_n)== 1, plist$b_n, pset[i])
    c_n0 <- ifelse(length(plist$c_n0)== 1, plist$c_n0, pset[i])
    exp_cn <- ifelse(length(plist$exp_cn)== 1, plist$exp_cn, pset[i])
    cn_mn <- ifelse(length(plist$cn_mn)== 1, plist$cn_mn, pset[i])
    
    # if changing a_n with c_n so a_n + c_n is always x times c_n:
    if(change_a == TRUE && length(plist$c_n0) > 1){
      a_n <- pset[i]*ac_mult
    }
    
    a_m <- ifelse(length(plist$a_m)== 1, plist$a_m, pset[i])
    b_m <- ifelse(length(plist$b_m)== 1, plist$b_m, pset[i])
    c_m <- ifelse(length(plist$c_m)== 1, plist$c_m, pset[i])
    
    if(change_a == TRUE && length(plist$c_m) > 1){
      a_m <- pset[i]*ac_mult
    }
    
    Dinf <- ifelse(length(plist$Dinf)== 1, plist$Dinf, pset[i])
    Dmin <- ifelse(length(plist$Dmin)== 1, plist$Dmin, pset[i])
    g0 <- ifelse(length(plist$g0)== 1, plist$g0, pset[i])
    exp_g <- ifelse(length(plist$exp_g)== 1, plist$exp_g, pset[i])
    g_mx <- ifelse(length(plist$g_mx)== 1, plist$g_mx, pset[i])
    
    Fmn <- ifelse(length(plist$Fmn)== 1, plist$Fmn, pset[i])
    Fconst <- ifelse(length(plist$Fconst)== 1, plist$Fconst, pset[i])
    Fexp <- ifelse(length(plist$Fexp)== 1, plist$Fexp, pset[i])
    
    eH <- ifelse(length(plist$eH)== 1, plist$eH, pset[i])
    Apatch <- ifelse(length(plist$Apatch)== 1, plist$Apatch, pset[i])
    z <- ifelse(length(plist$z)== 1, plist$z, pset[i])
    
    phi <- ifelse(length(plist$phi)== 1, plist$phi, pset[i])
    
    mP_pars <- list(K0 = K0, slope_mP = slope_mP)
    nH_pars <- list(a_n = a_n, b_n = b_n, c_n0 = c_n0, exp_cn = exp_cn, cn_mn = cn_mn)
    mH_pars <- list(a_m = a_m, b_m = b_m, c_m = c_m)
    G_pars <- list(Dinf = Dinf, g0 = g0, exp_g = exp_g, g_mx = g_mx, Dmin = Dmin)
    F_pars <- list(Fmn = Fmn, Fconst = Fconst, Fexp = Fexp)
    
    
    # areas for calculating total area occupied
    # boundaries of the host size classes: 0-Fmn, Fmn-90% of max size, >90% of max size
    Amax <- pi*(1/2*Dinf)^2
    Amin <- pi*(1/2*Dmin)^2
    A12 <- Fmn
    A23 <- 0.9*Amax
    
    # midpoints (used for calculating area occupied by each class; same as avg area in each class)
    A <- c((Amin + A12)/2, (A23+A12)/2, (Amax+A23)/2)
    
    
    # now run the model
    sim1 <- mod_fun3(tmax, P0, H0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi)
    
    # now process and store the results in Heq1 and Peq1
    FH_i <- c(0, avg_fec(A12, A23, Fmn, Fconst, Fexp), avg_fec(A23, Amax, Fmn, Fconst, Fexp))
    Atot_i <- sum(sim1$H[,tmax]*A)
    
    Heq1[i, 1:5] <- c(sum(sim1$H[,tmax]*A), sum(sim1$H[,tmax]), sim1$H[1,tmax], sim1$H[2,tmax], sim1$H[3,tmax])
    propH <- abs((sum(sim1$H[,tmax])-sum(sim1$H[,tmax-10]))/sum(sim1$H[,tmax-10]))
    Heq1[i, 6] <- ifelse(propH > eqtol, 1, 0)
    
    HFeq1[i] <- (sim1$H[2,tmax]*FH_i[2] + sim1$H[3,tmax]*FH_i[3])*max(0, 1-Atot_i/Apatch)
    
    Peq1[i, 1:4] <- c(sum(sim1$P[,tmax]), sim1$P[1,tmax], sim1$P[2,tmax], sim1$P[3,tmax])
    propP <- abs((sum(sim1$P[,tmax])-sum(sim1$P[,tmax-10]))/sum(sim1$P[,tmax-10]))
    Peq1[i, 5] <- ifelse(propP > eqtol, 1, 0)
    
  }
  
  return(list(Heq1 = Heq1, Peq1 = Peq1, HFeq1 = HFeq1))
  
}



```




# default parameters


```{r}
Amax <- pi*(50/2)^2 # max area of a host
Fmn <- pi*(14/2)^2 # area at which the host becomes reproductively mature
Amin <- pi*(1/2)^2 # minimum area of a host 
Apatch <- (Amax+0.9*Amax)/2*100 # size of patch

A_mids <- c((Amin+Fmn)/2, (0.9*Amax+Fmn)/2, (Amax+0.9*Amax)/2) # used for calculating area occupied

# initial conditions
H01 <- c(0.01, 10, 25) # high adults
H02 <- c(100, 5, 0.01) # high small

P01 <- c(0, 10, 50)
P02 <- c(0, 2, 0)

tmax <- 1000 # number of timesteps to run the model; needs to be > 10 for the equilibration check to work

eqtol <- 0.001 # prop difference btw abundance at tmax and tmax - 10 needs to be less than eqtol to consider the simulation to have equilibrated

# HOST DENSITY INDEPENDENT MORTALITY

ac_mult <-3 # mortality rate of smallest individuals is c*(ac_mult + 1), mortality rate of infinitely large individuals is c

c_n0 <- 0.05 # maximum baseline asymptotic host density independent mortality rate (DI mortality rate of an infinitely large host)
a_n <- ac_mult*c_n0 # DI mortality of smallest individuals is a_c + c_n
b_n <- 0.005 # rate of decrease in host DI mortality rate with increasing host area
exp_cn <- 0 # rate at which the asymptotic host DI mortality rate decreases with increasing partner density (b_cn in the main text)
cn_mn <- 0.001 # lowest possible asymptotic DI mortality rate
  
# HOST DENSITY DEPENDENT MORTALITY
c_m <- 0.05 # asymptotic host density dependent mortality rate (DD mortality rate of an infinitely large host)
a_m <- ac_mult*c_m # DD mortality rate of smallest individuals is a_m + c_m
b_m <- 0.005 # rate of decrease in host DD mortality rate with increasing host area

# HOST GROWTH
Dinf <- sqrt(Amax/pi)*2 # Amax = pi*(1/2*Dinf)^2 so Dinf = sqrt(Amax/pi)*2
Dmin <- sqrt(Amin/pi)*2 # Amax = pi*(1/2*Dinf)^2 so Dinf = sqrt(Amax/pi)*2
g0 <- 0.025 # min host growth rate; g0 = 0.025 means hosts become reproductively mature at about 2 yrs old 
exp_g <- 0 # rate of increase in host growth rate with increasing partner density (b_g in main text)
g_mx <- 0.1 # max host growth rate; become reproductively mature at about 6 months old

# HOST FECUNDITY
Fconst <- 0.25 # fecundity of a host at maturation
Fexp <- 0.00025 # rate of increase in host fecundity with host area

# external host recruitment
eH <- 0 # no external recruits

# PARTNER PARAMETERS
rP <- 1 # reproduction rate
nP <- 0.35 # density independent mortality rate
eP <- 0 # external partner recruitment

K0 <- 0.005 # baseline carrying capacity (inverse of baseline DD mortality rate)
slope_mP <- 0.0015 # slope of relationship between host volume and partner carrying capacity

phi <- 0 # strength of partner preference for adult hosts

# OTHER PARAMETERS
z <- 1 # 1 = system is closed, 0 = system is open

# default parameter list
plist <- list(rP = rP, nP = nP, K0 = K0, slope_mP = slope_mP, eP = eP, a_n = a_n, b_n = b_n, c_n0 = c_n0, exp_cn = exp_cn, cn_mn = cn_mn, a_m = a_m, b_m = b_m, c_m = c_m, Dinf = Dinf, g0 = g0, exp_g = exp_g, g_mx = g_mx, Dmin = Dmin, Fmn = Fmn, Fconst = Fconst, Fexp = Fexp, eH = eH, Apatch = Apatch, z = z, phi = phi)

plist_def <- plist # for sensitivity analyses

# lists for default simulation
mP_pars <- list(K0 = K0, slope_mP = slope_mP)
nH_pars <- list(a_n = a_n, b_n = b_n, c_n0 = c_n0, exp_cn = exp_cn, cn_mn = cn_mn)
mH_pars <- list(a_m = a_m, b_m = b_m, c_m = c_m)
G_pars <- list(Dinf = Dinf, g0 = g0, exp_g = exp_g, g_mx = g_mx, Dmin = Dmin)
F_pars <- list(Fmn = Fmn, Fconst = Fconst, Fexp = Fexp)


# DEFAULT EQUILIBRIUM
dsim1 <- mod_fun3(tmax, P01, H01, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi)

# dH1eq <- c(dsim1$H[1,tmax], dsim1$H[2,tmax], dsim1$H[3,tmax])
# dAeq <- sum(dsim1$H[ ,tmax]*c(Fmn/2, (0.9*Amax+Fmn)/2, (Amax+0.9*Amax)/2))

# check default
plot(x = dsim1$t, y = dsim1$H[1,], type = "l", ylim = c(0, max(as.vector(dsim1$H))), lty = 3, las = 1, xlab = "Time", ylab = "Host population size")
lines(x = dsim1$t, y = dsim1$H[2,], lty = 2)
lines(x = dsim1$t, y = dsim1$H[3,], lty = 1)
legend("topleft", title = "Host size", c("small", "medium", "large"), lty = c(3, 2, 1))

plot(x = dsim1$t, y = dsim1$P[1,], type = "l", ylim = c(0, max(as.vector(dsim1$P))), lty = 3, las = 1, xlab = "Time", ylab = "Partner population size")
lines(x = dsim1$t, y = dsim1$P[2,], lty = 2)
lines(x = dsim1$t, y = dsim1$P[3,], lty = 1)
legend("topleft", title = "Host size", c("small", "medium", "large"), lty = c(3, 2, 1))
    

dsim1$H[,tmax]

dsim1$P[,tmax]

PH_def <- dsim1$P[,tmax]/dsim1$H[,tmax]
PH_def



```



# Figures


## basic mutualism

plot with mutualism strength on x-axis and equilibrium on y-axis

```{r}

# phi = 0

# first get initial conditions

sim0 <- mod_fun3(tmax, P0 = P01, H0 = H01, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi = 0)


P0.00 <- sim0$P[,tmax]
H0.00 <- sim0$H[,tmax]

tmax0 <- 1000

# nutritional mutualism
exp_g_tests <- seq(from = 0, to = 2, length.out = 30)

Ptot_N0 <- rep(NA, length(exp_g_tests))
Htot_N0 <- rep(NA, length(exp_g_tests))


for(jj in 1:length(exp_g_tests)){
  
G_pars.01 <- G_pars
G_pars.01$exp_g <- exp_g_tests[jj]
nH_pars.01 <- nH_pars
nH_pars.01$exp_cn <- 0
  
  sim.0 <- mod_fun3(tmax0, P0.00, H0.00, rP, nP, mP_pars, eP, nH_pars.01, mH_pars, G_pars.01, F_pars, eH, Apatch, z, phi = 0)
  
  Ptot_N0[jj] <- sum(sim.0$P[, tmax0])
  Htot_N0[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  
}


# defensive mutualism
exp_cn_tests <- seq(from = 0, to = 2, length.out = 30)

Ptot_D0 <- rep(NA, length(exp_cn_tests))
Htot_D0 <- rep(NA, length(exp_cn_tests))

for(jj in 1:length(exp_cn_tests)){
  
G_pars.01 <- G_pars
G_pars.01$exp_g <- 0
nH_pars.01 <- nH_pars
nH_pars.01$exp_cn <- exp_cn_tests[jj]
  
  sim.0 <- mod_fun3(tmax0, P0.00, H0.00, rP, nP, mP_pars, eP, nH_pars.01, mH_pars, G_pars.01, F_pars, eH, Apatch, z, phi = 0)
  
  Ptot_D0[jj] <- sum(sim.0$P[, tmax0])
  Htot_D0[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  
}





```



plot results

```{r}

Dcol <- "#7B8BA5"
Ncol <- "#B66A40"


ylims.1 <- c(0, 750)

yaxs <- seq(from = ylims.1[1], to = ylims.1[2], by = 250)

ylims.2 <- c(0, 100000)
yaxs2 <- seq(from = ylims.2[1], to = ylims.2[2], by = 25000)

lwd.1 <- 2

#pdf("figures/eco_ND_PH.pdf", width = 7.5, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2, byrow = T), widths = rep(1, 2), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0.1), oma = c(4.5, 4.5, 2, 0.1))


#nutrition mutualism
xset <- exp_g_tests
xlab <- NA
xaxs <- seq(from = exp_g_tests[1], to = exp_g_tests[length(exp_g_tests)], by = 0.5)

plot(x = xset, y = Ptot_N0, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = 1, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1, labels = NA)
mtext(side = 3, "a) P*, nutritional mutualism", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, xlab)
mtext(side = 3, "Nutritional mutualism")
mtext(side = 2, "Number of partners", line = 3.25, cex = 1.2)

plot(x = xset, y = Ptot_D0, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = 1, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
mtext(side = 3, "c) P*, defensive mutualism", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 3, "Defensive mutualism")
axis(side = 2, at = yaxs, las = 1, labels = NA)
axis(side = 1, at = xaxs, las = 1, labels = NA)
mtext(side = 1, xlab, line = 2.5)

plot(x = xset, y = Htot_N0, ylim = ylims.2, type = "l", las = 1, col = Ncol, lty = 1, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "b) H*, nutritional mutualism", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 2, "Host cover", line = 3.25, cex = 1.2)
mtext(side = 1, "Strength of nutritional mutualism", line = 2)
axis(side = 1, at = xaxs, las = 1)
axis(side = 2, at = yaxs2, las = 1)
#mtext(side = 1, xlab, line = 2.5)


plot(x = xset, y = Htot_D0, ylim = ylims.2, type = "l", las = 1, col = Dcol, lty = 1, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "d) H*, defensive mutualism", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, "Strength of defensive mutualism", line = 2)
axis(side = 1, at = xaxs, las = 1)
axis(side = 2, at = yaxs2, las = 1, labels = NA)
mtext(side = 1, xlab, line = 2.5)

#dev.off()

```


## phi adaptive dynamics

show evolution of phi

```{r}


# evolution parameters
t_r <- 36 # calculate growth rate over first 3 years
mut_size <- 0.005 # 0.01
n_mut <- ceiling((1-0)/mut_size) # number of mutation events (make sure this is big enough that you can go from 0 to 1 in intervals of mut_size)


phiRI <- c(0, 0) # initial phi values

H0.0 <- c(10, 10, 10)
R0.0 <- c(10, 10, 10)

error_tol <- 0.001
eqtol <- 0.001

I0.1 <- c(0.01, 0.01, 0.01) # initial size of invading population


# eco opt parameters
left0 <- 0
right0 <- 1

phi_test_set <- seq(from = 0, to = 1, length.out = 30)

# Nutritional mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 1
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 0


# first get initial conditions
sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)


P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]

# now get the eco and evo phi values
eco_opt_Nex <- phiTSA_fun(left0 = 0, right0 = 1, error_tol, eqtol, tmax = 500, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi)

evo_ess_Nex <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = P0.5, I0 = I0.1, H0.5, rP, nP, mP_pars, eP, phi = phiRI, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, eqtol)

max(eco_opt_Nex$eq_check.1)
max(evo_ess_Nex$Heqs[,6], na.rm = T)

tmax0 <- 1000

Ptot_N <- rep(NA, length(phi_test_set))
Htot_N <- rep(NA, length(phi_test_set))

H1_N <- rep(NA, length(phi_test_set))
H2_N <- rep(NA, length(phi_test_set))
H3_N <- rep(NA, length(phi_test_set))

for(jj in 1:length(phi_test_set)){
  
  sim.0 <- mod_fun3(tmax0, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = phi_test_set[jj])
  
  Ptot_N[jj] <- sum(sim.0$P[, tmax0])
  Htot_N[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  H1_N[jj] <- sim.0$H[1, tmax0]
  H2_N[jj] <- sim.0$H[2, tmax0]
  H3_N[jj] <- sim.0$H[3, tmax0]
  
}


# Defensive mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 0
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 1

sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)


P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]

# now get the eco and evo phi values
eco_opt_Dex <- phiTSA_fun(left0 = 0, right0 = 1, error_tol, eqtol, tmax = 500, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi)

evo_ess_Dex <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = P0.5, I0 = I0.1, H0.5, rP, nP, mP_pars, eP, phi = phiRI, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, eqtol)

max(eco_opt_Dex$eq_check.1)
max(evo_ess_Dex$Heqs[,6], na.rm = T)



Ptot_D <- rep(NA, length(phi_test_set))
Htot_D <- rep(NA, length(phi_test_set))

H1_D <- rep(NA, length(phi_test_set))
H2_D <- rep(NA, length(phi_test_set))
H3_D <- rep(NA, length(phi_test_set))

for(jj in 1:length(phi_test_set)){
  
  sim.0 <- mod_fun3(tmax0, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = phi_test_set[jj])
  
  Ptot_D[jj] <- sum(sim.0$P[, tmax0])
  Htot_D[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  H1_D[jj] <- sim.0$H[1, tmax0]
  H2_D[jj] <- sim.0$H[2, tmax0]
  H3_D[jj] <- sim.0$H[3, tmax0]
  
}



# no partner effects

Ptot_Df <- rep(NA, length(phi_test_set))
Htot_Df <- rep(NA, length(phi_test_set))

H1_Df <- rep(NA, length(phi_test_set))
H2_Df <- rep(NA, length(phi_test_set))
H3_Df <- rep(NA, length(phi_test_set))

for(jj in 1:length(phi_test_set)){
  
  sim.0 <- mod_fun3(tmax0, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi = phi_test_set[jj])
  
  Ptot_Df[jj] <- sum(sim.0$P[, tmax0])
  Htot_Df[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  H1_Df[jj] <- sim.0$H[1, tmax0]
  H2_Df[jj] <- sim.0$H[2, tmax0]
  H3_Df[jj] <- sim.0$H[3, tmax0]
  
}

# eco_opt_Nex$P
# (evo_ess_Nex$Reqs[199,1] + evo_ess_Nex$Reqs[200,1])/2
# 
# eco_opt_Nex$HA
# (evo_ess_Nex$Heqs[199,1] + evo_ess_Nex$Heqs[200,1])/2

```



check the phi values

```{r}

eco_opt_Nex$phi
eco_opt_Dex$phi

indxNex <- max(which(is.na(evo_ess_Nex$phiR)==F))
(evo_ess_Nex$phiR[indxNex] + evo_ess_Nex$phiR[indxNex-1])/2

indxDex <- max(which(is.na(evo_ess_Dex$phiR)==F))
(evo_ess_Dex$phiR[indxDex] + evo_ess_Dex$phiR[indxDex-1])/2

```


check adaptive dynamics

```{r}

# resident phi = partner maximizing

G_pars.3 <- G_pars
G_pars.3$exp_g <- 1
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 0


# first get initial conditions (equilibrium in absence of invader)
sim_test <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = eco_opt_Nex$phi)

# now test invasion 
RIsim1 <- RImod_fun(tmax = 4000, R0 = sim_test$P[,tmax], I0 = c(0.01, 0.01, 0.01), H0 = sim_test$H[,tmax], rP, nP, mP_pars, eP, phi = c(eco_opt_Nex$phi, 0.92), nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z)

plot(x = RIsim1$t, y = RIsim1$R[1,] + RIsim1$R[2,] + RIsim1$R[3,], type = "l", ylim = c(0, 500), las = 1, xlab = "Time", ylab = "Partner population size", col = "dodgerblue")
abline(h = sum(sim_test$P[,tmax]), col = "dodgerblue", lty = 2) # resident equilibrium
lines(x = RIsim1$t, y = RIsim1$I[1,] + RIsim1$I[2,] + RIsim1$I[3,], col = "firebrick")
legend("right", legend = c("resident", "invader"), col = c("dodgerblue", "firebrick"), lwd = 1, bty = "n")


# reverse this: start the resident at the ESS
sim_test <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.92)


RIsim2 <- RImod_fun(tmax = 4000, R0 = sim_test$P[,tmax], I0 = c(0.01, 0.01, 0.01), H0 = sim_test$H[,tmax], rP, nP, mP_pars, eP, phi = c(0.92, eco_opt_Nex$phi), nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z)

plot(x = RIsim2$t, y = RIsim2$R[1,] + RIsim2$R[2,] + RIsim2$R[3,], type = "l", ylim = c(0, 500), las = 1, xlab = "Time", ylab = "Partner population size", col = "dodgerblue")
abline(h = sum(sim_test$P[,tmax]), col = "dodgerblue", lty = 2) # resident equilibrium
lines(x = RIsim2$t, y = RIsim2$I[1,] + RIsim2$I[2,] + RIsim2$I[3,], col = "firebrick")
legend("right", legend = c("resident", "invader"), col = c("dodgerblue", "firebrick"), lwd = 1, bty = "n")


```


plot

```{r}

# first column = Nutritional mutualism, top = evo, bottom = eco; second column = Defensive mutualism

# eco_opt_test$phi
# evo_ess_test$phiR[(n_mut-4):n_mut]
#evo_ess_test$phiR

Dcol <- "#7B8BA5"
Ncol <- "#B66A40"

Lcol <- "gray35"

#pdf("figures/phi_ess_ex.pdf", width = 6, height = 3.5)
par(mfrow = c(1, 2))
layout(matrix(c(1, 2), nrow = 1, ncol = 2, byrow = F), widths = rep(1, 2), heights = rep(1, 1))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 2.5, 2, 0.5))

yaxt1 <- seq(from = 0, to = 1, by = 0.2)
xaxt1 <- seq(from = 0, to = 200, by = 50)

plot(c(1:n_mut), evo_ess_Nex$phiR, type = "l", las = 1, col = Ncol, ylim = c(0, 1), lwd = 2, xaxt = "n", yaxt = "n")
mtext(side = 1, "Mutation number", line = 2.25, outer = T)
#mtext(side = 2, "Resident phi", line = 2.5)
mtext(side = 2, expression(Resident~phi), line = 2.25)
mtext(side = 3, "Nutritional mutualism")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, las = 1)
text(170, 0.09, "Partner \nmaximizing", cex = 0.8)
text(30, 0.87, "Partner ESS", cex = 0.8)
indxNex <- max(which(is.na(evo_ess_Nex$phiR)==F))
abline(h = (evo_ess_Nex$phiR[indxNex]+evo_ess_Nex$phiR[indxNex-1])/2, lty = 2, col = Lcol)
abline(h = eco_opt_Nex$phi, lty = 1, col = Lcol)
lines(c(1:n_mut), evo_ess_Nex$phiR, col = Ncol) # replot to be on top
# add segment for the last part where the population just stays at the ESS
segments(indxNex, (evo_ess_Nex$phiR[indxNex]+evo_ess_Nex$phiR[indxNex-1])/2, n_mut, col = Ncol, lwd = 2)

plot(c(1:n_mut), evo_ess_Dex$phiR, type = "l", las = 1, col = Dcol, ylim = c(0, 1), lwd = 2, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, labels = NA)
mtext(side = 3, "Defensive mutualism")
indxDex <- max(which(is.na(evo_ess_Dex$phiR)==F))
abline(h = (evo_ess_Dex$phiR[indxDex]+evo_ess_Dex$phiR[indxDex-1])/2, lty = 2, col = Lcol)
abline(h = eco_opt_Dex$phi, lty = 1, col = Lcol)
lines(c(1:n_mut), evo_ess_Dex$phiR, col = Dcol) # replot to be on top
#legend("bottomright", legend  = c("Partner \nmaximizing", "ESS"), lty = c(1, 2), lwd =1.5, col = Lcol, bty = "n", cex = 0.8)

#dev.off()



# plot(x = phi_test_set, y = Ptot_N, type = "l", las = 1, lwd = 2.5, xlab = NA, ylab = NA, col = Ncol) # , ylim = c(2000, 2200)
# mtext(side = 1, "Phi", line = 2.5)
# mtext(side = 2, "Partner population size", line = 3)
# abline(v = (evo_ess_Nex$phiR[n_mut]+evo_ess_Nex$phiR[n_mut-1])/2, lty = 2, col = Lcol)
# abline(v = eco_opt_Nex$phi, lty = 1, col = Lcol)

```



## Fig 2

plot equilibrium as a function of phi for multiple mutualism strengths

```{r}
phi_test_set <- seq(from = 0, to = 1, length.out = 30) # phi values

mut_test_set <- seq(from = 0, to = 1.25, by = 0.25) # mutualism strengths

# Nutritional mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 1
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 0


# first get initial conditions

sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)


P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]

tmax0 <- 1000

Ptot_N_list <- list()
Htot_N_list <- list()


for(ii in 1:length(mut_test_set)){
  
Ptot_N_ii <- rep(NA, length(phi_test_set))
Htot_N_ii <- rep(NA, length(phi_test_set))

G_pars.ii <- G_pars
G_pars.ii$exp_g <- mut_test_set[ii]
nH_pars.ii <- nH_pars
nH_pars.ii$exp_cn <- 0

for(jj in 1:length(phi_test_set)){
  
  sim.0 <- mod_fun3(tmax0, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.ii, mH_pars, G_pars.ii, F_pars, eH, Apatch, z, phi = phi_test_set[jj])
  
  Ptot_N_ii[jj] <- sum(sim.0$P[, tmax0])
  Htot_N_ii[jj] <- sum(sim.0$H[, tmax0]*A_mids)

  
}

Ptot_N_list[[ii]] <- Ptot_N_ii
Htot_N_list[[ii]] <- Htot_N_ii

  
}


# Defensive mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 0
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 1

sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)


P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]


Ptot_D_list <- list()
Htot_D_list <- list()

for(ii in 1:length(mut_test_set)){

Ptot_D_ii <- rep(NA, length(phi_test_set))
Htot_D_ii <- rep(NA, length(phi_test_set))

G_pars.ii <- G_pars
G_pars.ii$exp_g <- 0
nH_pars.ii <- nH_pars
nH_pars.ii$exp_cn <- mut_test_set[ii]

for(jj in 1:length(phi_test_set)){
  
  sim.0 <- mod_fun3(tmax0, P0.5, H0.5, rP, nP, mP_pars, eP, nH_pars.ii, mH_pars, G_pars.ii, F_pars, eH, Apatch, z, phi = phi_test_set[jj])
  
  Ptot_D_ii[jj] <- sum(sim.0$P[, tmax0])
  Htot_D_ii[jj] <- sum(sim.0$H[, tmax0]*A_mids)
  
  
}

Ptot_D_list[[ii]] <- Ptot_D_ii
Htot_D_list[[ii]] <- Htot_D_ii

}


# check that relationships are unimodal
# which(Ptot_N_list[[1]]==max(Ptot_N_list[[1]])) 
# plot(x = phi_test_set, y = Ptot_N_list[[1]], type = "l") 
# plot(x = phi_test_set, y = Ptot_D_list[[6]], type = "l")

```


plot the results

```{r}


Dcol <- "#7B8BA5"
Ncol <- "#B66A40"

leg_col <- "gray40"

alpha_set <- seq(from = 0.2, to = 1, length.out = length(mut_test_set))


#pdf("figures/phi_opt_main_v3.pdf", width = 6.5, height = 5)
par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4, 5, 5), nrow = 2, ncol = 3, byrow = F), widths = c(1, 1, 0.5), heights = rep(1, 2))
#layout.show(5)
par(mar=c(0.25, 3, 0.5, 0), oma = c(4.5, 4.5, 1.75, 0))

# floor(min(Ptot_N_list[[1]]))
# ceiling(max(Ptot_D_list[[length(mut_test_set)]]))
# 
# floor(min(Htot_N_list[[1]]))
# ceiling(max(Htot_D_list[[length(mut_test_set)]]))

xaxt1 <- seq(from = 0, to = 1, by = 0.25)
yaxt1 <- seq(from = 300, to = 700, by = 100)
yaxt2 <- seq(from = 47700, to = 88600, by = 10000)

plot(x = phi_test_set, y = Ptot_N_list[[1]], type = "l", las = 1, lwd = 2.5, xlab = NA, ylab = NA, col = adjustcolor(Ncol, alpha.f = alpha_set[1]), ylim = c(min(yaxt1), max(yaxt1)), xaxt = "n", yaxt = "n") 
for(pp in 2:length(mut_test_set)){
  lines(phi_test_set, y = Ptot_N_list[[pp]], type = "l", lwd = 2.5, col = adjustcolor(Ncol, alpha.f = alpha_set[pp]))
}
mtext(side = 2, "Number of partners", line = 3.5, cex = 1.1)
mtext(side = 3, "Nutritional mutualism")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt1, las = 1)
#abline(v = eco_opt_Nex$phi, lty = 1, col = Lcol)

plot(x = phi_test_set, y = Htot_N_list[[1]], type = "l", las = 1, lwd = 2.5, xlab = NA, ylab = NA, col = adjustcolor(Ncol, alpha.f = alpha_set[1]), ylim = c(min(yaxt2), max(yaxt2)), xaxt = "n", yaxt = "n")
for(pp in 2:length(mut_test_set)){
  lines(phi_test_set, y = Htot_N_list[[pp]], type = "l", lwd = 2.5, col = adjustcolor(Ncol, alpha.f = alpha_set[pp]))
}
#mtext(side = 1, "Strength of partner preference for adult hosts (phi)", line = 2.5, outer = T, cex = 1)
mtext(side = 1, expression(Strength~of~partner~preference~'for'~adult~hosts~(phi)), line = 2.5, outer = T, cex = 1, adj = 0.3)
mtext(side = 2, "Host cover", line = 3.5, cex = 1.1)
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt2, las = 1)


plot(x = phi_test_set, y = Ptot_D_list[[1]], type = "l", las = 1, lwd = 2.5, xlab = NA, ylab = NA, col = adjustcolor(Dcol, alpha.f = alpha_set[1]), ylim = c(min(yaxt1), max(yaxt1)), xaxt = "n", yaxt = "n") 
for(pp in 2:length(mut_test_set)){
  lines(phi_test_set, y = Ptot_D_list[[pp]], type = "l", lwd = 2.5, col = adjustcolor(Dcol, alpha.f = alpha_set[pp]))
}
mtext(side = 3, "Defensive mutualism")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt1, las = 1, hadj  = 0.75)
#abline(v = eco_opt_Dex$phi, lty = 1, col = Lcol)
#legend("left", legend  = c("Partner \nmaximizing", "ESS"), lty = c(1, 2), lwd =1.5, col = Lcol, bty = "n")

plot(x = phi_test_set, y = Htot_D_list[[1]], type = "l", las = 1, lwd = 2.5, xlab = NA, ylab = NA, col = adjustcolor(Dcol, alpha.f = alpha_set[1]), ylim = c(min(yaxt2), max(yaxt2)), xaxt = "n", yaxt = "n")
for(pp in 2:length(mut_test_set)){
  lines(phi_test_set, y = Htot_D_list[[pp]], type = "l", lwd = 2.5, col = adjustcolor(Dcol, alpha.f = alpha_set[pp]))
}
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt2, las = 1, hadj = 0.75)
#abline(v = eco_opt_Dex$phi, lty = 1, col = Lcol)

#par(mar=c(0, 0, 0, 0), oma = c(4.5, 4.5, 1.75, 0))
plot(NULL, xlim=c(0,1), ylim=c(0,1), ylab=NA, xlab=NA, las = 1, xaxt = "n", yaxt = "n", frame.plot = F)
legend("topleft", legend = as.character(mut_test_set), col = c(adjustcolor(leg_col, alpha.f = alpha_set[1]), adjustcolor(leg_col, alpha.f = alpha_set[2]), adjustcolor(leg_col, alpha.f = alpha_set[3]), adjustcolor(leg_col, alpha.f = alpha_set[4]), adjustcolor(leg_col, alpha.f = alpha_set[5]), adjustcolor(leg_col, alpha.f = alpha_set[6])), bty = "n", title = "Strength of partner's \neffects on host", lwd = 4, ncol = 1, cex = 1.1, inset = c(-0.5, 0.35), xpd = T)


#dev.off()

```


## eco evo phis

```{r}

# evolution parameters
t_r <- 36 # calculate growth rate over first 3 years
mut_size <- 0.005 # 0.01
n_mut <- ceiling((1-0)/mut_size) # number of mutation events (make sure this is big enough that you can go from 0 to 1 in intervals of mut_size)

phiRI <- c(0, 0) # initial phi values

H0.0 <- c(10, 10, 10)
R0.0 <- c(10, 10, 10)

error_tol <- 0.001
eqtol <- 0.001

I0.1 <- c(0.01, 0.01, 0.01) # initial size of invading population


# eco opt parameters
left0 <- 0
right0 <- 1

length1 <- 20 

# parameter sets
exp_g_set <- seq(from = 0, to = 2, length.out = length1)
exp_cn_set <- seq(from = 0, to = 2, length.out = length1)

G_pars.1 <- G_pars
nH_pars.1 <- nH_pars

slope_mP_set <- c(0.0015, 0.00015)

```



```{r}
# simulations


tic()

# high slope_mP
mP_pars.1 <- list(K0 = K0, slope_mP = slope_mP_set[1])

# Nutritional mutualism
par_choice <- "exp_g"
par_set <- exp_g_set

ecoevo1 <- EcoEvo_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1, mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo1$eco_eq) # did all eco sims equilibrate?
max(ecoevo1$evo_eq) # did all evo sims equilibrate?
max(ecoevo1$evo_growth) # max number of mutations for which both mutants has positive growth

# save results
ecoevo.exp_g.HmP <- ecoevo1

# Defensive mutualism
par_choice <- "exp_cn"
par_set <- exp_cn_set

ecoevo1 <- EcoEvo_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1,mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo1$eco_eq) 
max(ecoevo1$evo_eq) 
max(ecoevo1$evo_growth) 

# save results
ecoevo.exp_cn.HmP <- ecoevo1


# low slope_mP
mP_pars.1 <- list(K0 = K0, slope_mP = slope_mP_set[2])

# Nutritional mutualism
par_choice <- "exp_g"
par_set <- exp_g_set

ecoevo1 <- EcoEvo_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1, mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo1$eco_eq) # did all eco sims equilibrate?
max(ecoevo1$evo_eq) # did all evo sims equilibrate?
max(ecoevo1$evo_growth) # max number of mutations for which both mutants has positive growth

# save results
ecoevo.exp_g.LmP <- ecoevo1

# Defensive mutualism
par_choice <- "exp_cn"
par_set <- exp_cn_set

ecoevo1 <- EcoEvo_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1,mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo1$eco_eq) 
max(ecoevo1$evo_eq) 
max(ecoevo1$evo_growth) 

# save results
ecoevo.exp_cn.LmP <- ecoevo1

toc() # takes about 50 min



# NA's in eq check occur if phi reached a stable value and the adaptive dynamics stopped early (so the last parts were NA)


```





repeat for host cover optimizing value of phi

```{r}
# simulations


tic()

# high slope_mP
mP_pars.1 <- list(K0 = K0, slope_mP = slope_mP_set[1])

# Nutritional mutualism
par_choice <- "exp_g"
par_set <- exp_g_set

ecoH1 <- EcoH_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1, mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoH1$eco_eq) # did all eco sims equilibrate?

# save results
ecoH.exp_g.HmP <- ecoH1

# Defensive mutualism
par_choice <- "exp_cn"
par_set <- exp_cn_set

ecoH1 <- EcoH_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1,mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoH1$eco_eq) 

# save results
ecoH.exp_cn.HmP <- ecoH1


# low slope_mP
mP_pars.1 <- list(K0 = K0, slope_mP = slope_mP_set[2])

# Nutritional mutualism
par_choice <- "exp_g"
par_set <- exp_g_set

ecoH1 <- EcoH_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1, mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoH1$eco_eq) # did all eco sims equilibrate?

# save results
ecoH.exp_g.LmP <- ecoH1

# Defensive mutualism
par_choice <- "exp_cn"
par_set <- exp_cn_set

ecoH1 <- EcoH_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1,mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoH1$eco_eq) 

# save results
ecoH.exp_cn.LmP <- ecoH1

toc() # about 10 min



# check results
ecoH.exp_g.HmP$eco_phi 
ecoH.exp_g.LmP$eco_phi 
ecoH.exp_cn.HmP$eco_phi  
ecoH.exp_cn.LmP$eco_phi 
# remember the first element doesn't make since because H will be the same across all phi values if P have no effect on H

```



## PIP

pair-wise invasion plot

```{r}
# testing function
# G_pars.2 <- G_pars
# G_pars.2$exp_g <- 0
# nH_pars.2 <- nH_pars
# nH_pars.2$exp_cn <- 1
# 
# phi_set1 <- seq(from = 0, to = 1, length.out = 10)
# 
# tic()
# pip_test <- PIP_fun(phi_set1, t_r, tmax, R0 = R0.0, I0 = I0.1, H0 = H0.0, rP, nP, mP_pars, eP, phi = c(0, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)
# toc()
# 
# pip_test # row = resident, column = mutant, 1 = invades
# phi_set1


```



```{r}

# simulations
phi_set1 <- seq(from = 0, to = 1, length.out = 80)

tic()
# Nutritional mutualism
G_pars.2 <- G_pars
G_pars.2$exp_g <- 1
nH_pars.2 <- nH_pars
nH_pars.2$exp_cn <- 0


pip1 <- PIP_fun(phi_set1, t_r, tmax, R0 = R0.0, I0 = I0.1, H0 = H0.0, rP, nP, mP_pars, eP, phi = c(0, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)

pip.exp_g <- pip1

# Defensive mutualism
G_pars.2 <- G_pars
G_pars.2$exp_g <- 0
nH_pars.2 <- nH_pars
nH_pars.2$exp_cn <- 1

pip1 <- PIP_fun(phi_set1, t_r, tmax, R0 = R0.0, I0 = I0.1, H0 = H0.0, rP, nP, mP_pars, eP, phi = c(0, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)

pip.exp_cn <- pip1

toc() # about 40 min



```



```{r}
# translate output into matrices for plotting

imat <- pip.exp_g$inv_mat

mLW01 <- matrix(NA, nrow = length(phi_set1), ncol = length(phi_set1))
mWL10 <- matrix(NA, nrow = length(phi_set1), ncol = length(phi_set1))

for(i in 1:length(phi_set1)){ # for each resident phi
  
  for(j in 1:(length(phi_set1)-1)){ # for each mutant trait
    
    if(imat[i, j]==0 && imat[i, j + 1]==1){
      
      mLW01[i,j] <- (phi_set1[j] + phi_set1[j+1])/2 # mutant went from losing to winning
      
    } 
    
    if(imat[i, j]==1 && imat[i, j + 1]==0){
      mWL10[i,j] <- (phi_set1[j] + phi_set1[j+1])/2 # mutant went from winning to losing
    } 
    
  }
  
}

# if i = 0 and i+1 = 1, record (phi[i] + phi[i+1])/2
# if i = 1 and i+1 = 0, record (phi[i] + phi[i+1])/2 in another category


# check how many lines are needed (how many transitions there are in each row)
n_transLW <- rep(NA, 80)
n_transWL <- rep(NA, 80)

for(i in 1:length(phi_set1)){
  n_transLW[i] <- length(which(is.na(mLW01[i,])==F))
  n_transWL[i] <- length(which(is.na(mWL10[i,])==F))
}

#n_transLW + n_transWL # never have a lose to win and then a win to lose for the same resident value

#n_transWL

lose_win <- rep(NA, 80)
win_lose <- rep(NA, 80)

for(i in 1:length(phi_set1)){
  
  not_NA <- length(which(is.na(mLW01[i,])==F))
  lose_win[i] <- ifelse(not_NA > 0 , mLW01[i, which(is.na(mLW01[i,])==F)], NA)
  
  not_NA <- length(which(is.na(mWL10[i,])==F))
  win_lose[i] <- ifelse(not_NA > 0 ,mWL10[i, which(is.na(mWL10[i,])==F)], NA)
}

lose_win_g <- lose_win
win_lose_g <- win_lose


# repeat for Defensive mutualism

imat <- pip.exp_cn$inv_mat

mLW01 <- matrix(NA, nrow = length(phi_set1), ncol = length(phi_set1))
mWL10 <- matrix(NA, nrow = length(phi_set1), ncol = length(phi_set1))

for(i in 1:length(phi_set1)){ # for each resident phi
  
  for(j in 1:(length(phi_set1)-1)){ # for each mutant trait
    
    if(imat[i, j]==0 && imat[i, j + 1]==1){
      
      mLW01[i,j] <- (phi_set1[j] + phi_set1[j+1])/2 # mutant went from losing to winning
      
    } 
    
    if(imat[i, j]==1 && imat[i, j + 1]==0){
      mWL10[i,j] <- (phi_set1[j] + phi_set1[j+1])/2 # mutant went from winning to losing
    } 
    
  }
  
}


# check how many lines are needed (how many transitions there are in each row)
n_transLW <- rep(NA, 80)
n_transWL <- rep(NA, 80)

for(i in 1:length(phi_set1)){
  n_transLW[i] <- length(which(is.na(mLW01[i,])==F))
  n_transWL[i] <- length(which(is.na(mWL10[i,])==F))
}

#n_transLW + n_transWL # never have a lose to win and then a win to lose for the same resident value

#n_transWL

lose_win <- rep(NA, 80)
win_lose <- rep(NA, 80)

for(i in 1:length(phi_set1)){
  
  not_NA <- length(which(is.na(mLW01[i,])==F))
  lose_win[i] <- ifelse(not_NA > 0 , mLW01[i, which(is.na(mLW01[i,])==F)], NA)
  
  not_NA <- length(which(is.na(mWL10[i,])==F))
  win_lose[i] <- ifelse(not_NA > 0 ,mWL10[i, which(is.na(mWL10[i,])==F)], NA)
}

lose_win_cn <- lose_win
win_lose_cn <- win_lose



```


```{r}
# get example trajectories to add to the PIP plots

G_pars.2 <- G_pars
G_pars.2$exp_g <- 1
nH_pars.2 <- nH_pars
nH_pars.2$exp_cn <- 0

evo_exp_g.0 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(0, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)

evo_exp_g.1 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(1, 1), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)


G_pars.2 <- G_pars
G_pars.2$exp_g <- 0
nH_pars.2 <- nH_pars
nH_pars.2$exp_cn <- 1

evo_exp_cn.0 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(0, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)

evo_exp_cn.1 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(1, 1), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)


```



```{r}

# plot results


Wcol <- Ncol
ADcol <- "black"

lose_win <- lose_win_g
win_lose <- win_lose_g

xaxt1 <- seq(from = 0, to = 1, by = 0.2)
yaxt1 <- seq(from = 0, to = 1, by = 0.2)

#pdf("figures/PIP.pdf", width = 8, height = 4)

par(mfrow = c(1, 2))
layout(matrix(c(1, 2), nrow = 1, ncol = 2, byrow = F), widths = rep(1, 2), heights = rep(1, 1))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 4.5, 2, 0.5))

plot(x = phi_set1, y = lose_win, type = "l", ylim = c(0, 1), xlim = c(0.01, 0.99), las = 1, col = Wcol, xaxs = "i", yaxs = "i", xaxt = "n", yaxt = "n", xlab  = NA, ylab = NA) #, asp = 1 # adjust the x-axis limits a tiny bit to make the plot go all the way to the edges
mtext(side = 3, "a) Nutritional mutualism", adj = 0)
axis(side = 1, at = xaxt1)
axis(side = 1, at = c(0.01, 0.99), labels = c(0, 1))
axis(side = 2, at = yaxt1, las = 1)
mtext(side = 1, expression(Resident~phi), line = 2, outer = T)
mtext(side = 2, expression(Mutant~phi), line = 2.5)
lines(x = phi_set1, y = win_lose, col = Wcol)
mn <- min(which(is.na(lose_win)==F))
mx <- max(which(is.na(lose_win)==F))
polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(1, length(mn:mx)), rev(lose_win[which(is.na(lose_win)==F)])), col = Wcol, border = NA)
mn <- min(which(is.na(win_lose)==F))
mx <- max(which(is.na(win_lose)==F))
polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(0, length(mn:mx)), rev(win_lose[which(is.na(win_lose)==F)])), col = Wcol, border = NA)

# add trajectories and ESS
lines(x = evo_exp_g.0$phiR[1:(n_mut-1)], y = evo_exp_g.0$phiR[2:n_mut], col = ADcol, lwd = 3)
lines(x = evo_exp_g.1$phiR[1:(n_mut-1)], y = evo_exp_g.1$phiR[2:n_mut], col = ADcol, lwd = 3)
indxNex <- max(which(is.na(evo_ess_Nex$phiR)==F))
points(x = (evo_exp_g.0$phiR[indxNex] + evo_exp_g.0$phiR[indxNex-1])/2, y = (evo_exp_g.0$phiR[indxNex] + evo_exp_g.0$phiR[indxNex-1])/2, col = ADcol, pch = 16, cex = 1.5)


Wcol <- Dcol

lose_win <- lose_win_cn
win_lose <- win_lose_cn

plot(x = phi_set1, y = lose_win, type = "l", ylim = c(0, 1), xlim = c(0.01, 0.99), las = 1, col = Wcol, xaxs = "i", yaxs = "i", xaxt = "n", yaxt = "n", xlab  = NA, ylab = NA) #, asp = 1 # adjust the x-axis limits a tiny bit to make the plot go all the way to the edges
mtext(side = 3, "b) Defensive mutualism", adj = 0)
axis(side = 1, at = xaxt1)
axis(side = 1, at = c(0.01, 0.99), labels = c(0, 1))
axis(side = 2, at = yaxt1, las = 1, labels = NA)
lines(x = phi_set1, y = win_lose, col = Wcol)
mn <- min(which(is.na(lose_win)==F))
mx <- max(which(is.na(lose_win)==F))
polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(1, length(mn:mx)), rev(lose_win[which(is.na(lose_win)==F)])), col = Wcol, border = NA)
mn <- min(which(is.na(win_lose)==F))
mx <- max(which(is.na(win_lose)==F))
polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(0, length(mn:mx)), rev(win_lose[which(is.na(win_lose)==F)])), col = Wcol, border = NA)

# add trajectories and ESS
lines(x = evo_exp_cn.0$phiR[1:(n_mut-1)], y = evo_exp_cn.0$phiR[2:n_mut], col = ADcol, lwd = 3)
lines(x = evo_exp_cn.1$phiR[1:(n_mut-1)], y = evo_exp_cn.1$phiR[2:n_mut], col = ADcol, lwd = 3)
points(x = (evo_exp_cn.0$phiR[n_mut] + evo_exp_cn.0$phiR[n_mut-1])/2, y = (evo_exp_cn.0$phiR[n_mut] + evo_exp_cn.0$phiR[n_mut-1])/2, col = ADcol, pch = 16, cex = 1.5)


#dev.off()


```



```{r}
# try another example trajectory that starts in the middle

# G_pars.2 <- G_pars
# G_pars.2$exp_g <- 1
# nH_pars.2 <- nH_pars
# nH_pars.2$exp_cn <- 0
# 
# evo_exp_g.05 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(0.5, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)
# 
# evo_exp_g.95 <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = R0.0, I0.1, H0.0, rP, nP, mP_pars, eP, phi = c(0.95, 0), nH_pars.2, mH_pars, G_pars.2, F_pars, eH, Apatch, z, eqtol)
# 
# Wcol <- Ncol
# 
# plot(x = phi_set1, y = lose_win, type = "l", ylim = c(0, 1), xlim = c(0.01, 0.99), las = 1, col = Wcol, xaxs = "i", yaxs = "i", xaxt = "n", yaxt = "n", xlab  = NA, ylab = NA) #, asp = 1 # adjust the x-axis limits a tiny bit to make the plot go all the way to the edges
# axis(side = 1, at = c(0.01, 0.99), labels = c(0, 1))
# axis(side = 2, at = yaxt1, las = 1)
# mtext(side = 1, "Resident phi", line = 2, outer = T)
# mtext(side = 2, "Mutant phi", line = 2.5)
# lines(x = phi_set1, y = win_lose, col = Wcol)
# mn <- min(which(is.na(lose_win)==F))
# mx <- max(which(is.na(lose_win)==F))
# polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(1, length(mn:mx)), rev(lose_win[which(is.na(lose_win)==F)])), col = Wcol, border = NA)
# mn <- min(which(is.na(win_lose)==F))
# mx <- max(which(is.na(win_lose)==F))
# polygon(c(phi_set1[mn:mx], rev(phi_set1[mn:mx])), c(rep(0, length(mn:mx)), rev(win_lose[which(is.na(win_lose)==F)])), col = Wcol, border = NA)
# 
# # add trajectories and ESS
# lines(x = evo_exp_g.05$phiR[1:(n_mut-1)], y = evo_exp_g.05$phiR[2:n_mut], col = ADcol, lwd = 3)
# lines(x = evo_exp_g.95$phiR[1:(n_mut-1)], y = evo_exp_g.95$phiR[2:n_mut], col = ADcol, lwd = 3)

```




## Barplot and preferences

for default N and D cases, make a barplot comparing P and host cover on all the host stages and total at the partner maximizing and partner ESS values



```{r}
# get the eco and evo results for the default parameter combinations

# Nutritional mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 1
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 0

ecoevoNdef <- EcoEvo_fun(par_choice = "exp_g", par_set = c(1), tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi, phiRI)

 
# EcoEvo_fun doesn't record H from each size class so need to re-run the phi_opt simulations
ecoNdef <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = ecoevoNdef$eco_phi)

# Defensive mutualism
G_pars.3 <- G_pars
G_pars.3$exp_g <- 0
nH_pars.3 <- nH_pars
nH_pars.3$exp_cn <- 1

ecoevoDdef <- EcoEvo_fun(par_choice = "exp_cn", par_set = c(1), tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi, phiRI)

ecoDdef <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = ecoevoDdef$eco_phi)


ecoevoNdef$eco_eq
ecoevoNdef$evo_eq
ecoevoDdef$eco_eq
ecoevoDdef$evo_eq

```


calculate Manly-chesson partner preferences for comparison with empirical data

```{r}

# start with nutritional mutualism
indxNex.1 <- max(which(is.na(ecoevoNdef$evo_list[[1]]$phiR)==F))

Heqs.N1.evo <- (ecoevoNdef$evo_list[[1]]$Heqs[indxNex.1,3:5] + ecoevoNdef$evo_list[[1]]$Heqs[indxNex.1-1,3:5])/2
Peqs.N1.evo <- (ecoevoNdef$evo_list[[1]]$Reqs[indxNex.1,2:4] + ecoevoNdef$evo_list[[1]]$Reqs[indxNex.1-1,2:4])/2


Peqs.N1.eco <- ecoevoNdef$eco_list[[1]]$P_all
Heqs.N1.eco <- ecoevoNdef$eco_list[[1]]$H_all

# get preferences
Ppref.N1.evo <- Peqs.N1.evo/(Heqs.N1.evo*A_mids/sum(Heqs.N1.evo*A_mids))
Ppref.N1.evo <- Ppref.N1.evo/sum(Ppref.N1.evo)

Ppref.N1.evo

Ppref.N1.eco <- Peqs.N1.eco/(Heqs.N1.eco*A_mids/sum(Heqs.N1.eco*A_mids))
Ppref.N1.eco <- Ppref.N1.eco/sum(Ppref.N1.eco)
Ppref.N1.eco


# repeat for defensive mutualism

indxDex.1 <- max(which(is.na(ecoevoDdef$evo_list[[1]]$phiR)==F))

Heqs.D1.evo <- (ecoevoDdef$evo_list[[1]]$Heqs[indxDex.1,3:5] + ecoevoDdef$evo_list[[1]]$Heqs[indxDex.1-1,3:5])/2
Peqs.D1.evo <- (ecoevoDdef$evo_list[[1]]$Reqs[indxDex.1,2:4] + ecoevoDdef$evo_list[[1]]$Reqs[indxDex.1-1,2:4])/2


Peqs.D1.eco <- ecoevoDdef$eco_list[[1]]$P_all
Heqs.D1.eco <- ecoevoDdef$eco_list[[1]]$H_all

# get preferences

Ppref.D1.evo <- Peqs.D1.evo/(Heqs.D1.evo*A_mids/sum(Heqs.D1.evo*A_mids))
Ppref.D1.evo <- Ppref.D1.evo/sum(Ppref.D1.evo)

Ppref.D1.evo

Ppref.D1.eco <- Peqs.D1.eco/(Heqs.D1.eco*A_mids/sum(Heqs.D1.eco*A_mids))
Ppref.D1.eco <- Ppref.D1.eco/sum(Ppref.D1.eco)
Ppref.D1.eco


# also compare phi = 0 with no fish effects

phi0_pref <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars, mH_pars, G_pars, F_pars, eH, Apatch, z, phi = 0)

Peqs.0.0 <- phi0_pref$P[,tmax]
Heqs.0.0 <- phi0_pref$H[,tmax]

Ppref.0 <- Peqs.0.0/(Heqs.0.0*A_mids/sum(Heqs.0.0*A_mids))
Ppref.0 <- Ppref.0/sum(Ppref.0)

Ppref.0

```


```{r}

# #pdf("figures/model_preferences.pdf", width = 6, height = 4)
# 
# par(mfrow = c(1, 1))
# par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 4.5, 2, 2.5))
# 
# 
# plot(x = A_mids, y = Ppref.N1.evo, pch = 16, col = Ncol, las = 1, ylim = c(0, 0.6), type = "o", xlab = NA, ylab = NA, lwd = 3, cex = 1.1)
# mtext(side = 1, "Host area", line = 2)
# mtext(side = 2, "Partner preference", line = 2.5)
# lines(x = A_mids, y = Ppref.D1.evo, pch = 16, col = Dcol, type = "o", lty = 1, lwd = 2)
# lines(x = A_mids, y = Ppref.0, pch = 16, col = "black", type = "o", lty = 1, lwd = 2)
# abline(h = 1/length(A_mids), lty = 2)
# legend(x = "bottomright", legend = c("Nutritional ESS", "Defensive ESS", "Null, phi = 0"), col = c(Ncol, Dcol, "black"), bty = "n", pch = 16, lty = 1)
# 
# 
# dev.off()

```



```{r}

# process results for barplot

# function that returns ratio of abundances at partner maximizing vs ESS phi values
diff_fun <- function(ecoevo_def, eco_def){
  
  indx <- max(which(is.na(ecoevo_def$evo_list[[1]]$Reqs[,1])==F))
  
  
  denom <- (ecoevo_def$evo_list[[1]]$Reqs[indx,1]+ecoevo_def$evo_list[[1]]$Reqs[indx-1,1])/2
  
  Ptot <- (ecoevo_def$eco_list[[1]]$P-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Heqs[indx,1]+ecoevo_def$evo_list[[1]]$Heqs[indx-1,1])/2
  
  HAtot <- (ecoevo_def$eco_list[[1]]$HA-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Reqs[indx,2]+ecoevo_def$evo_list[[1]]$Reqs[indx-1,2])/2
  P1 <- (eco_def$P[1,tmax]-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Reqs[indx,3]+ecoevo_def$evo_list[[1]]$Reqs[indx-1,3])/2
  P2 <- (eco_def$P[2,tmax]-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Reqs[indx,4]+ecoevo_def$evo_list[[1]]$Reqs[indx-1,4])/2
  P3 <- (eco_def$P[3,tmax]-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Heqs[indx,3]+ecoevo_def$evo_list[[1]]$Heqs[indx-1,3])/2
  H1 <- (eco_def$H[1,tmax]-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Heqs[indx,4]+ecoevo_def$evo_list[[1]]$Heqs[indx-1,4])/2
  H2 <- (eco_def$H[2,tmax]-denom)/denom
  
  denom <- (ecoevo_def$evo_list[[1]]$Heqs[indx,5]+ecoevo_def$evo_list[[1]]$Heqs[indx-1,5])/2
  H3 <- (eco_def$H[3,tmax]-denom)/denom
  
  
  # add % difference in total fecundity
  FH_df <- c(0, avg_fec(Fmn, 0.9*Amax, F_pars$Fmn, F_pars$Fconst, F_pars$Fexp), avg_fec(0.9*Amax, Amax, F_pars$Fmn, F_pars$Fconst, F_pars$Fexp))
  
# evo values  
  
Atot_evo1 <- ecoevo_def$evo_list[[1]]$Heqs[indx,1]
Atot_evo2 <- ecoevo_def$evo_list[[1]]$Heqs[indx-1,1]

F_evo1 <- (ecoevo_def$evo_list[[1]]$Heqs[indx,4]*FH_df[2] + ecoevo_def$evo_list[[1]]$Heqs[indx,5]*FH_df[3])*max(0, 1-Atot_evo1/Apatch)

F_evo2 <- (ecoevo_def$evo_list[[1]]$Heqs[indx-1,4]*FH_df[2] + ecoevo_def$evo_list[[1]]$Heqs[indx-1,5]*FH_df[3])*max(0, 1-Atot_evo2/Apatch)

F_evo <- (F_evo1 + F_evo2)/2

F_eco <- (eco_def$H[2,tmax]*FH_df[2] + eco_def$H[3,tmax]*FH_df[3])*max(0, 1-ecoevo_def$eco_list[[1]]$HA/Apatch)


FA <- (F_eco - F_evo)/F_evo  
  
  # return named list with % difference between eco and evo phi abundances for Ptot, HA, and P on each size class and number of hosts in each size class
  
  return(list(Ptot = Ptot, HAtot = HAtot, P1 = P1, P2 = P2, P3 = P3, H1 = H1, H2 = H2, H3 = H3, FA = FA))
  
}


# diff_fun(ecoecoNdef, ecoNdef)
# diff_fun(ecoecoDdef, ecoDdef)
# 
# #ecoecoDdef
# 
# plot(c(0, 1), c(0, 1))
# rect(xleft = 0, ybottom = 0, xright = 1, ytop = 1, col = "gray")
# 


```



## Fig 3



```{r}

Dcol <- "#7B8BA5"
Ncol <- "#B66A40"
Dfcol <- "gray"

lwd.1 <- 2.5
lty.eco <- 1
lty.evo <- 2

lty.H <- 3

ylims.1 <- c(0, 1.05)

yaxs <- seq(from = 0, to = 1, by = 0.2)


#pdf("figures/eco_evoPH_comb2.pdf", width = 8, height = 6)

par(mfrow = c(3, 2))
layout(matrix(c(1, 1, 2, 2, 3, 4, 4, 5), nrow = 2, ncol = 4, byrow = T), widths = c(0.5, 1, 1, 0.5, 0.5, 1, 1, 0.5), heights = rep(1, 8))
#layout.show(5)
par(mar=c(3, 1.25, 0.5, 0), oma = c(2, 4.5, 1.25, 0.5))


# phi as a function of mutualism strength
xset <- exp_g_set
xlab <- NA
xaxs <- seq(from = exp_g_set[1], to = exp_g_set[length1], by = 0.5)

ecoevo.p <- ecoevo.exp_g.HmP 

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1, padj = -0.75)
#mtext(side = 3, "a) Nutritional, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 3, expression("A)"~phi*", Nutritional mutualism"), adj = 0.05, line = -1.75, cex = 0.9)
mtext(side = 1, expression("Strength of partner's effect on host growth"~"("*b[g]*")"), line = 2, outer = F, cex = 0.9)
#mtext(side = 3, "Nutritional mutualism")
mtext(side = 1, xlab, line = 2.5)
mtext(side = 2, expression(Strength~of~partner~preference), line = 3.75, cex = 0.95)
mtext(side = 2, expression('for'~adult~hosts~(phi)), line = 2.5, cex = 0.95)
lines(x = xset, y = ecoevo.p$evo_phi, col = Ncol, lty = lty.evo, lwd = lwd.1)
legend("right", legend = c("Partner maximizing", "Partner ESS"), lty = c(lty.eco, lty.evo), lwd = 2, bty = "n", col = "gray20", cex = 1.1)

#abline(v = 1)


ecoevo.p <- ecoevo.exp_cn.HmP 

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, expression("B)"~phi*", Defensive mutualism"), adj = 0.05, line = -1.75, cex = 0.9)
#mtext(side = 3, "Defensive mutualism")
axis(side = 1, at = xaxs, las = 1, padj = -0.75)
axis(side = 2, at = yaxs, las = 1, labels = NA)
mtext(side = 1, xlab, line = 2.5)
mtext(side = 1, expression("Strength of partner's effect on host survival"~"("*b[cn]*")"), line = 2, outer = F, cex = 0.9)
lines(x = xset, y = ecoevo.p$evo_phi, col = Dcol, lty = lty.evo, lwd = lwd.1)


# empty plot
plot.new()

# barplot

N_r <- diff_fun(ecoevoNdef, ecoNdef)
D_r <- diff_fun(ecoevoDdef, ecoDdef)

r_w <- 0.25 # rectangle widths

r_x <- seq(from = 1, to = 11, by = 2)#c(1, 2.5)

plot(c(0, 12), c(0, 25), pch = NA, xaxt = "n", yaxt = "n", las = 1, xlab = NA, ylab = NA)
axis(side = 1, at = r_x, labels = c("No. of \npartners", "Host \ncover", "Host \nfecundity", "H1", "H2", "H3"), padj = c(0.2, 0.2, 0.2, 0, 0, 0), cex.axis = 0.95)
axis(side = 2, at = seq(from = 0, to = 35, by = 10), las = 1)
mtext(side = 3, "C) Percent differences between equilibria", adj = 0.05, line = -1.75, cex = 0.9)
mtext(side = 1, "Abundance metric", line = 2.75, cex = 0.9)
mtext(side = 2, "% Difference between \npartner maximizing and ESS", line = 2.5, cex = 0.95)
rect(xleft = r_x[1]-2*r_w, ybottom = 0, xright = r_x[1], ytop = N_r$Ptot*100, col = Ncol, border = Ncol)
rect(xleft = r_x[1], ybottom = 0, xright = r_x[1]+2*r_w, ytop = D_r$Ptot*100, col = Dcol, border = Dcol)
# HA tot
rect(xleft = r_x[2]-2*r_w, ybottom = 0, xright = r_x[2], ytop = N_r$HAtot*100, col = Ncol, border = Ncol)
rect(xleft = r_x[2], ybottom = 0, xright = r_x[2]+2*r_w, ytop = D_r$HAtot*100, col = Dcol, border = Dcol)
# HF tot
rect(xleft = r_x[3]-2*r_w, ybottom = 0, xright = r_x[3], ytop = N_r$HAtot*100, col = Ncol, border = Ncol)
rect(xleft = r_x[3], ybottom = 0, xright = r_x[3]+2*r_w, ytop = D_r$HAtot*100, col = Dcol, border = Dcol)
# H1 
rect(xleft = r_x[4]-2*r_w, ybottom = 0, xright = r_x[4], ytop = N_r$H1*100, col = Ncol, border = Ncol)
rect(xleft = r_x[4], ybottom = 0, xright = r_x[4]+2*r_w, ytop = D_r$H1*100, col = Dcol, border = Dcol)
# H2
rect(xleft = r_x[5]-2*r_w, ybottom = 0, xright = r_x[5], ytop = N_r$H2*100, col = Ncol, border = Ncol)
rect(xleft = r_x[5], ybottom = 0, xright = r_x[5]+2*r_w, ytop = D_r$H2*100, col = Dcol, border = Dcol)
# H3
rect(xleft = r_x[6]-2*r_w, ybottom = 0, xright = r_x[6], ytop = N_r$H3*100, col = Ncol, border = Ncol)
rect(xleft = r_x[6], ybottom = 0, xright = r_x[6]+2*r_w, ytop = D_r$H3*100, col = Dcol, border = Dcol)
legend("topleft", legend = c(expression(Nutritional~mutualism~"("*b[g]==1*")"), expression(Defensive~mutualism~"("*b[cn]==1*")")), fill = c(Ncol, Dcol), bty = "n", inset = c(0, 0.125), cex = 1.1)

# empty plot
plot.new()

#dev.off()



```



## disturbance

for Nutritional mutualism: recovery and/or sensitivity to disturbance and change in environmental conditions


```{r}

# get the phi_opt and ESS values for the Nutritional mutualism

# Nutritional mutualism
G_pars.4 <- G_pars
G_pars.4$exp_g <- 1
nH_pars.4 <- nH_pars
nH_pars.4$exp_cn <- 0


ecoevoN_ts <- EcoEvo_fun(par_choice = "exp_g", par_set = c(1), tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevoN_ts$eco_eq)
max(ecoevoN_ts$evo_eq)

phi_eco <- ecoevoN_ts$eco_phi
phi_evo <- ecoevoN_ts$evo_phi

# initial conditions: first get default equilibrium for Nutritional mutualism (at the ESS phi)

evo_sim0 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_evo)

# check equilibration
plot(x = evo_sim0$t, y = evo_sim0$H[1,], type = "l", ylim = c(0, max(as.vector(evo_sim0$H))), lty = 3, las = 1, xlab = "Time", ylab = "Host population size")
lines(x = evo_sim0$t, y = evo_sim0$H[2,], lty = 2)
lines(x = evo_sim0$t, y = evo_sim0$H[3,], lty = 1)
legend("topleft", title = "Host size", c("small", "medium", "large"), lty = c(3, 2, 1))

plot(x = evo_sim0$t, y = evo_sim0$P[1,], type = "l", ylim = c(0, max(as.vector(evo_sim0$P))), lty = 3, las = 1, xlab = "Time", ylab = "Partner population size")
lines(x = evo_sim0$t, y = evo_sim0$P[2,], lty = 2)
lines(x = evo_sim0$t, y = evo_sim0$P[3,], lty = 1)
legend("topleft", title = "Host size", c("small", "medium", "large"), lty = c(3, 2, 1))


# store equilibrium values as initial conditions
H0_ts <- evo_sim0$H[,tmax]
P0_ts <- evo_sim0$P[,tmax]

# now vary the proportional reduction in H and P from each size class
p123 <- c(0.01, 0.01, 0.01) # all reduced to 1% of pre-disturbance abundance

# run the timeseries with eco and evo phi values

evo_p123 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_evo)
eco_p123 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_eco)


# repeat for different env conditions
# lower growth rate
G_pars.5 <- G_pars.4
G_pars.5$g0 <- 0.7*g0

evo_p123.g0 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.5, F_pars, eH, Apatch, z, phi = phi_evo)
eco_p123.g0 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.5, F_pars, eH, Apatch, z, phi = phi_eco)


# fecundity
F_pars.5 <- F_pars
F_pars.5$Fconst <- 0.7*Fconst

evo_p123.Fconst <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars.5, eH, Apatch, z, phi = phi_evo)
eco_p123.Fconst <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars.5, eH, Apatch, z, phi = phi_eco)


# higher mortality rate
nH_pars.5 <- nH_pars.4
nH_pars.5$c_n0 <- 1.3*c_n0

evo_p123.c_n0 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.5, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_evo)
eco_p123.c_n0 <- mod_fun3(tmax, P0 = P0_ts*p123, H0 = H0_ts*p123, rP, nP, mP_pars, eP, nH_pars.5, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_eco)



```


SM figure: full time series

```{r}
# plot results

tset.p <- evo_p123$t


lwd.2 <- 2
pch1 <- 16
cex1 <- 1.5


xmax <- 375
ymax1 <- 500
ymax2 <- 64000

xaxt1 <- seq(from = 0, to = xmax, by = 75)
yaxt1 <- seq(from = 0, to = ymax1, by = 100)
yaxt2 <- seq(from = 0, to = ymax2, by = 10000)

#pdf("figures/ts_full.pdf", width = 10, height = 5)

par(mfrow = c(2, 4))
layout(matrix(c(1, 2, 3, 4, 5, 6, 7, 8), nrow = 2, ncol = 4, byrow = F), widths = rep(1, 4), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(5, 4.5, 2, 0.5))


evo.p <- evo_p123
eco.p <- eco_p123

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)
P_evo <- apply(evo.p$P, 2, sum)
P_eco <- apply(eco.p$P, 2, sum)


tr_eco <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

plot(x = tset.p, y = HA_evo, type = "l", lty = 2, ylim = c(0, ymax2), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
mtext(side = 3, "Disturbance, no env. change", cex = 0.9)
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt2, las = 1)
mtext(side = 1, "Time since disturbance (months)", cex = 0.9, line = 2.5, outer = T)
mtext(side = 2, "Host cover", cex = 0.9, line = 3.5)
lines(x = tset.p, y = HA_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = HA_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = HA_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)
legend("bottomright", legend = c("Partner maximizing", "Partner ESS"), lty = c(1, 2), lwd = lwd.2, bty = "n", col = Ncol, cex = 1.1)

plot(x = tset.p, y = P_evo, type = "l", lty = 2, ylim = c(0, ymax1), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, las = 1)
mtext(side = 2, "Number of partners", cex = 0.9, line = 2.75)
lines(x = tset.p, y = P_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = P_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = P_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)


evo.p <- evo_p123.g0
eco.p <- eco_p123.g0

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)
P_evo <- apply(evo.p$P, 2, sum)
P_eco <- apply(eco.p$P, 2, sum)

tr_eco <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

plot(x = tset.p, y = HA_evo, type = "l", lty = 2, ylim = c(0, ymax2), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt2, labels = NA)
mtext(side = 3, "Disturbance + reduced growth rate", cex = 0.9)
lines(x = tset.p, y = HA_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = HA_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = HA_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)

plot(x = tset.p, y = P_evo, type = "l", lty = 2, ylim = c(0, ymax1), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, labels = NA)
lines(x = tset.p, y = P_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = P_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = P_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)

evo.p <- evo_p123.Fconst
eco.p <- eco_p123.Fconst

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)
P_evo <- apply(evo.p$P, 2, sum)
P_eco <- apply(eco.p$P, 2, sum)


tr_eco <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

plot(x = tset.p, y = HA_evo, type = "l", lty = 2, ylim = c(0, ymax2), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt2, labels = NA)
mtext(side = 3, "Disturbance + reduced fecundity", cex = 0.9)
lines(x = tset.p, y = HA_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = HA_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = HA_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)

plot(x = tset.p, y = P_evo, type = "l", lty = 2, ylim = c(0, ymax1), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, labels = NA)
lines(x = tset.p, y = P_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = P_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = P_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)

evo.p <- evo_p123.c_n0
eco.p <- eco_p123.c_n0

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)
P_evo <- apply(evo.p$P, 2, sum)
P_eco <- apply(eco.p$P, 2, sum)


tr_eco <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

plot(x = tset.p, y = HA_evo, type = "l", lty = 2, ylim = c(0, ymax2), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt2, labels = NA)
mtext(side = 3, "Disturbance + increased mortality", cex = 0.9)
lines(x = tset.p, y = HA_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = HA_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = HA_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)

plot(x = tset.p, y = P_evo, type = "l", lty = 2, ylim = c(0, ymax1), xlim  = c(0, xmax), col = Ncol, lwd = lwd.2, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt1, labels = NA)
lines(x = tset.p, y = P_eco, type = "l", col = Ncol, lwd = lwd.2)
points(x = tr_eco, y = P_eco[tr_eco], pch = pch1, cex = cex1, col = Ncol)
points(x = tr_evo, y = P_evo[tr_evo], pch = pch1, cex = cex1, col = Ncol)


#dev.off()

# Ptot_evo <- apply(evo.p$P, 2, sum)
# Ptot_eco <- apply(eco.p$P, 2, sum)
# 
# plot(x = tset.p, y = Ptot_evo, type = "l", lty = 2, ylim = c(0, 2000), xlim  = c(0, xmax))
# lines(x = tset.p, y = Ptot_eco, type = "l")


```


now vary post-disturbance g0, Fconst, and c_n0 

```{r}


length.2 <- 10
g0_set.1 <- seq(from = 0.1*g0, to = g0, length.out = length.2)

# time to recovery (host)
tr_eco.g0 <- rep(NA, length.2)
tr_evo.g0 <- rep(NA, length.2)

# time to recovery (partner)
tr_eco.g0.P <- rep(NA, length.2)
tr_evo.g0.P <- rep(NA, length.2)

# host cover at equilibrium
HA_evo.g0 <- rep(NA, length.2)
HA_eco.g0 <- rep(NA, length.2)

# partner abundance at equilibrium
P_evo.g0 <- rep(NA, length.2)
P_eco.g0 <- rep(NA, length.2)


for(i in 1:length.2){
  
G_pars.5 <- G_pars.4
G_pars.5$g0 <- g0_set.1[i]

evo.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.5, F_pars, eH, Apatch, z, phi = phi_evo)
eco.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.5, F_pars, eH, Apatch, z, phi = phi_eco)

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)

HA_evo.g0[i] <- HA_evo[tmax]
HA_eco.g0[i] <- HA_eco[tmax]

tr_eco.g0[i] <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo.g0[i] <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

Ptot_evo <- apply(evo.p$P, 2, sum)
Ptot_eco <- apply(eco.p$P, 2, sum)
P_evo.g0[i] <- Ptot_evo[tmax]
P_eco.g0[i] <- Ptot_eco[tmax]

tr_eco.g0.P[i] <- min(which(abs((Ptot_eco-Ptot_eco[tmax])) < 0.01*Ptot_eco[tmax]))
tr_evo.g0.P[i] <- min(which(abs((Ptot_evo-Ptot_evo[tmax])) < 0.01*Ptot_evo[tmax]))


  
}



Fconst_set.1 <- seq(from = 0.5*Fconst, to = Fconst, length.out = length.2)

tr_eco.Fconst <- rep(NA, length.2)
tr_evo.Fconst <- rep(NA, length.2)
tr_eco.Fconst.P <- rep(NA, length.2)
tr_evo.Fconst.P <- rep(NA, length.2)

# host cover at equilibrium
HA_evo.Fconst <- rep(NA, length.2)
HA_eco.Fconst <- rep(NA, length.2)

# partner abundance at equilibrium
P_evo.Fconst <- rep(NA, length.2)
P_eco.Fconst <- rep(NA, length.2)

for(i in 1:length.2){
  
F_pars.5 <- F_pars
F_pars.5$Fconst <- Fconst_set.1[i]

evo.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars.5, eH, Apatch, z, phi = phi_evo)
eco.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.4, mH_pars, G_pars.4, F_pars.5, eH, Apatch, z, phi = phi_eco)

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)

HA_evo.Fconst[i] <- HA_evo[tmax]
HA_eco.Fconst[i] <- HA_eco[tmax]

tr_eco.Fconst[i] <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo.Fconst[i] <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

Ptot_evo <- apply(evo.p$P, 2, sum)
Ptot_eco <- apply(eco.p$P, 2, sum)
P_evo.Fconst[i] <- Ptot_evo[tmax]
P_eco.Fconst[i] <- Ptot_eco[tmax]

tr_eco.Fconst.P[i] <- min(which(abs((Ptot_eco-Ptot_eco[tmax])) < 0.01*Ptot_eco[tmax]))
tr_evo.Fconst.P[i] <- min(which(abs((Ptot_evo-Ptot_evo[tmax])) < 0.01*Ptot_evo[tmax]))

  
}


c_n0_set.1 <- seq(from = c_n0, to = 1.75*c_n0, length.out = length.2)

tr_eco.c_n0 <- rep(NA, length.2)
tr_evo.c_n0 <- rep(NA, length.2)
tr_eco.c_n0.P <- rep(NA, length.2)
tr_evo.c_n0.P <- rep(NA, length.2)

# host cover at equilibrium
HA_evo.c_n0 <- rep(NA, length.2)
HA_eco.c_n0 <- rep(NA, length.2)

# partner abundance at equilibrium
P_evo.c_n0 <- rep(NA, length.2)
P_eco.c_n0 <- rep(NA, length.2)

for(i in 1:length.2){
  
nH_pars.5 <- nH_pars.4
nH_pars.5$c_n0 <- c_n0_set.1[i]

evo.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.5, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_evo)
eco.p <- mod_fun3(tmax, P0 = R0.0*p123, H0 = H0.0*p123, rP, nP, mP_pars, eP, nH_pars.5, mH_pars, G_pars.4, F_pars, eH, Apatch, z, phi = phi_eco)

HA_evo <- apply(evo.p$H*A_mids, 2, sum)
HA_eco <- apply(eco.p$H*A_mids, 2, sum)

HA_evo.c_n0[i] <- HA_evo[tmax]
HA_eco.c_n0[i] <- HA_eco[tmax]

tr_eco.c_n0[i] <- min(which(abs((HA_eco-HA_eco[tmax])) < 0.01*HA_eco[tmax]))
tr_evo.c_n0[i] <- min(which(abs((HA_evo-HA_evo[tmax])) < 0.01*HA_evo[tmax]))

Ptot_evo <- apply(evo.p$P, 2, sum)
Ptot_eco <- apply(eco.p$P, 2, sum)
P_evo.c_n0[i] <- Ptot_evo[tmax]
P_eco.c_n0[i] <- Ptot_eco[tmax]

tr_eco.c_n0.P[i] <- min(which(abs((Ptot_eco-Ptot_eco[tmax])) < 0.01*Ptot_eco[tmax]))
tr_evo.c_n0.P[i] <- min(which(abs((Ptot_evo-Ptot_evo[tmax])) < 0.01*Ptot_evo[tmax]))

  
}


# here defining recovery as within 1% of new post-disturbance equilibrium

```



```{r}

# compare time when partner recovers to time when host recovers
# tr_eco.g0-tr_eco.g0.P
# 
# tr_evo.g0-tr_evo.g0.P
# 
# tr_eco.Fconst-tr_eco.Fconst.P
# 
# tr_evo.Fconst-tr_evo.Fconst.P
# 
# tr_eco.c_n0-tr_eco.c_n0.P
# 
# tr_evo.c_n0-tr_evo.c_n0.P

# partner always takes a little longer to recover

```


### Fig 5
```{r}


lwd.2 <- 2

xaxt.g0 <- seq(from = 0, to = 0.025, by = 0.005)
xaxt.Fconst <- seq(from = 0, to = 0.25, by = 0.03)
xaxt.c_n0 <- seq(from = 0.05, to = 0.1, by = 0.01)


#pdf("figures/eco_evo_tr.pdf", width = 8, height = 5)

par(mfrow = c(2, 3))
layout(matrix(c(1, 2, 3, 4, 5, 6), nrow = 2, ncol = 3, byrow = T), widths = rep(1, 3), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(5, 4.5, 2, 0.5))

ymax_tr <- 1000
yaxt2 <- seq(from = 0, to = ymax_tr, by = 250)


plot(x = g0_set.1, y = tr_evo.g0.P, type = "l", lty = 2, ylim = c(0, ymax_tr), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
lines(x = g0_set.1, y = tr_eco.g0.P, lty = 1, lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.g0, labels = NA)
axis(side = 2, at = yaxt2, las = 1)
mtext(side = 3, "Disturbance + reduced growth rate", cex = 0.9)
mtext(side = 2, "Recovery time (months)", cex = 0.9, line = 3)
legend("topright", legend = c("Partner maximizing", "Partner ESS"), lty = c(1, 2), lwd = lwd.2, bty = "n", col = Ncol, cex = 1.1)
#abline(v = g0, lty = 3)

plot(x = Fconst_set.1, y = tr_evo.Fconst.P, type = "l", lty = 2, ylim = c(0, ymax_tr), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.Fconst, labels = NA)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = Fconst_set.1, y = tr_eco.Fconst.P, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 3, "Disturbance + reduced fecundity", cex = 0.9)
#abline(v = Fconst, lty = 3)

plot(x = c_n0_set.1, y = tr_evo.c_n0.P, type = "l", lty = 2, ylim = c(0, ymax_tr), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.c_n0, labels = NA)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = c_n0_set.1, y = tr_eco.c_n0.P, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 3, "Disturbance + increased mortality", cex = 0.9)
#abline(v = c_n0, lty = 3)

ymax_HA <- 64000
yaxt2 <- seq(from = 0, to = ymax_HA, by = 10000)

plot(x = g0_set.1, y = HA_evo.g0, type = "l", lty = 2, ylim = c(0, ymax_HA), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.g0)
axis(side = 2, at = yaxt2, las = 1)
lines(x = g0_set.1, y = HA_eco.g0, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n baseline host growth rate", line = 3.5, cex = 0.8)
mtext(side = 2, "Equilibrium host cover", cex = 0.9, line = 3.25)
#abline(v = g0, lty = 3)

plot(x = Fconst_set.1, y = HA_evo.Fconst, type = "l", lty = 2, ylim = c(0, ymax_HA), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.Fconst)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = Fconst_set.1, y = HA_eco.Fconst, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n host fecundity", line = 3.5, cex = 0.8)
#abline(v = Fconst, lty = 3)

plot(x = c_n0_set.1, y = HA_evo.c_n0, type = "l", lty = 2, ylim = c(0, ymax_HA), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.c_n0)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = c_n0_set.1, y = HA_eco.c_n0, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n host DI mortality rate", line = 3.5, cex = 0.8)
#abline(v = c_n0, lty = 3)

#dev.off()



```


SM figure: same as above but showing partner abundance instead of host cover, also SM figure with the full time series (see above)

```{r}


#pdf("figures/eco_evo_trP.pdf", width = 8, height = 3)

par(mfrow = c(2, 3))
layout(matrix(c(1, 2, 3), nrow = 1, ncol = 3, byrow = T), widths = rep(1, 3), heights = rep(1, 1))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(5, 4.5, 2, 0.5))


ymax_P <- 500
yaxt2 <- seq(from = 0, to = ymax_P, by = 100)

plot(x = g0_set.1, y = P_evo.g0, type = "l", lty = 2, ylim = c(0, ymax_P), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 2, at = yaxt2, las = 1)
axis(side = 1, at = xaxt.g0)
axis(side = 2, at = yaxt2, las = 1)
mtext(side = 3, "Disturbance + reduced growth rate", cex = 0.9)
lines(x = g0_set.1, y = P_eco.g0, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n baseline host growth rate", line = 3.5, cex = 0.8)
mtext(side = 2, "Equilibrium partner population size", cex = 0.9, line = 3)
legend("bottomright", legend = c("Partner maximizing", "Partner ESS"), lty = c(1, 2), lwd = lwd.2, bty = "n", col = Ncol, cex = 1.1)
#abline(v = g0, lty = 3)

plot(x = Fconst_set.1, y = P_evo.Fconst, type = "l", lty = 2, ylim = c(0, ymax_P), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.Fconst)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = Fconst_set.1, y = P_eco.Fconst, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n host fecundity", line = 3.5, cex = 0.8)
mtext(side = 3, "Disturbance + reduced fecundity", cex = 0.9)
#abline(v = Fconst, lty = 3)


plot(x = c_n0_set.1, y = P_evo.c_n0, type = "l", lty = 2, ylim = c(0, ymax_P), xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", lwd = lwd.2, col = Ncol)
axis(side = 1, at = xaxt.c_n0)
axis(side = 2, at = yaxt2, labels = NA)
lines(x = c_n0_set.1, y = P_eco.c_n0, lty = 1, lwd = lwd.2, col = Ncol)
mtext(side = 1, "Post-disturbance \n host DI mortality rate", line = 3.5, cex = 0.8)
mtext(side = 3, "Disturbance + increased mortality", cex = 0.9)
#abline(v = c_n0, lty = 3)


#dev.off()

```





## H sensitivity

basic sensitivity plot with no partners showing % change in host metrics (total cover, number of individuals in each size class, total reproductive output) as a function of % change in each host parameter

```{r}
#plist_def

# host parameters: a_n, b_n, c_n0, a_m, b_m, c_m, Dinf, g0, Fmn, Fexp, Fconst, Apatch

plist_def$exp_cn
plist_def$exp_g

# amount to vary parameters
px <- 0.25 
lx <- 10 # length of parameter sets

# NOTE: make sure Fmn is always less than Amax and greater than Amin
px*Fmn + Fmn
Amax
Amax-px*Amax
Fmn
Fmn-px*Fmn
Amin
Amin + px*Amin
Fmn
#pi*((Dinf-px*Dinf)/2)^2 # pi*(1/2*Dinf)^2


# initial conditions
H0.s <- c(10, 10, 10)
P0.s <- c(10, 10, 10)

# check tmax
#tmax

```


```{r}

# holding list: results for each different parameter combination
sensL7 <- list()
#sensL8 <- list()


tic()

# a_n = DI mortality of smallest class
plist1 <- plist_def
plist1$a_n <- seq(from = plist_def$a_n - px*plist_def$a_n, to = plist_def$a_n + px*plist_def$a_n, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

#max(abs(sens1$Heq1 - sens2$Heq1)) # check for initial condition dependence

# store results
sensL7[[1]] <- sens1
#sensL8[[1]] <- sens2


# b_n = rate of change in DI mortality with area
plist1 <- plist_def
plist1$b_n <- seq(from = plist_def$b_n - px*plist_def$b_n, to = plist_def$b_n + px*plist_def$b_n, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[2]] <- sens1
#sensL8[[2]] <- sens2

# c_n = DI mortality of largest hosts
plist1 <- plist_def
plist1$c_n0 <- seq(from = plist_def$c_n0 - px*plist_def$c_n0, to = plist_def$c_n0 + px*plist_def$c_n0, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[3]] <- sens1
#sensL8[[3]] <- sens2


# a_m = DD mortality of smallest class
plist1 <- plist_def
plist1$a_m <- seq(from = plist_def$a_m - px*plist_def$a_m, to = plist_def$a_m + px*plist_def$a_m, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[4]] <- sens1
#sensL8[[4]] <- sens2

# b_m = rate of change in DD mortality with area
plist1 <- plist_def
plist1$b_m <- seq(from = plist_def$b_m - px*plist_def$b_m, to = plist_def$b_m + px*plist_def$b_m, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[5]] <- sens1
#sensL8[[5]] <- sens2

# c_m = DD mortality of largest class
plist1 <- plist_def
plist1$c_m <- seq(from = plist_def$c_m - px*plist_def$c_m, to = plist_def$c_m + px*plist_def$c_m, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[6]] <- sens1
#sensL8[[6]] <- sens2

# Amax max size
# Amax <- pi*(Dinf/2)^2
# Dinf <- sqrt(Amax/pi)*2
plist1 <- plist_def
#sqrt((plist_def$Dinf/2)^2 - px*(plist_def$Dinf/2)^2)*2

plist1$Dinf <- seq(from = sqrt((plist_def$Dinf/2)^2 - px*(plist_def$Dinf/2)^2)*2, to = sqrt((plist_def$Dinf/2)^2 + px*(plist_def$Dinf/2)^2)*2, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[7]] <- sens1
#sensL8[[7]] <- sens2

# Amin min size
# Amin <- pi*(Dmin/2)^2
# Dmin <- sqrt(Amin/pi)*2
plist1 <- plist_def

plist1$Dmin <- seq(from = sqrt((plist_def$Dmin/2)^2 - px*(plist_def$Dmin/2)^2)*2, to = sqrt((plist_def$Dmin/2)^2 + px*(plist_def$Dmin/2)^2)*2, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[8]] <- sens1
#sensL8[[8]] <- sens2

# g0 = growth rate
plist1 <- plist_def
plist1$g0 <- seq(from = plist_def$g0 - px*plist_def$g0, to = plist_def$g0 + px*plist_def$g0, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[9]] <- sens1
#sensL8[[9]] <- sens2

# Fmn = size at reproductive maturity
plist1 <- plist_def
plist1$Fmn <- seq(from = plist_def$Fmn - px*plist_def$Fmn, to = plist_def$Fmn + px*plist_def$Fmn, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[10]] <- sens1
#sensL8[[10]] <- sens2

# Fexp = rate of increase in fecundity with area
plist1 <- plist_def
plist1$Fexp <- seq(from = plist_def$Fexp - px*plist_def$Fexp, to = plist_def$Fexp + px*plist_def$Fexp, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[11]] <- sens1
#sensL8[[11]] <- sens2

# Fconst = baseline fecundity at reproductive maturation
plist1 <- plist_def
plist1$Fconst <- seq(from = plist_def$Fconst - px*plist_def$Fconst, to = plist_def$Fconst + px*plist_def$Fconst, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[12]] <- sens1
#sensL8[[12]] <- sens2


# Apatch = total area of patch
plist1 <- plist_def
plist1$Apatch <- seq(from = plist_def$Apatch - px*plist_def$Apatch, to = plist_def$Apatch + px*plist_def$Apatch, length.out = lx)

sens1 <- sens_fun(tmax, P0.s, H0.s, plist1, eqtol)
#sens2 <- sens_fun(tmax, P0, H02, plist1, eqtol)

# store results
sensL7[[13]] <- sens1
#sensL8[[13]] <- sens2

toc() 



# check equilibration

# sensL7[[13]]$Heq1[,6]

```




plot each size class individually

```{r}

# plot results
ymn <- -0.45*100
ymx <- 0.45*100

yax <- seq(-0.4, 0.4, by = 0.2)*100
xax <- seq(-0.2, 0.2, by = 0.1)*100


# get default values
dH1eq <- c(dsim1$H[1,tmax], dsim1$H[2,tmax], dsim1$H[3,tmax])
dAeq <- sum(dsim1$H[ ,tmax]*c(Fmn/2, (0.9*Amax+Fmn)/2, (Amax+0.9*Amax)/2))

p_x <- seq(from = -px, to = px, length.out = 10)*100

# c(a_n, b_n, c_n0, a_m, b_m, c_m, Dinf, g0, Fmn, Fexp, Fconst, Apatch)

#pdf("figures/sensH123.pdf", width = 6, height = 8)
par(mfrow = c(5, 3))
layout(matrix(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15), nrow = 5, ncol = 3, byrow = T), widths = rep(1, 3), heights = rep(1, 5))
#layout.show(10)
par(mar=c(0, 1.25, 0.5, 0), oma = c(3.5, 3, 0.5, 0.5))

psim <- sensL7[[1]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
#mtext(side = 3, line = -1.5, "a) a_n", adj = 0.05)
mtext(side = 3, line = -1.5, expression(a*")"~a[n]), adj = 0.05)
mtext(side = 2, line = 1.5, "% change in population size", outer = T)
mtext(side = 1, line = 2.1, "% change in parameter", outer = T)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)
#legend("bottomleft", c("1", "2", "3"), lty = c(3, 2, 1, 1), col = c("black", "black", "black"), ncol = 2, lwd = 2, title = "Size class", bty = "n")

psim <- sensL7[[2]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "b) b_n", adj = 0.05)
mtext(side = 3, line = -1.5, expression(b*")"~b[n]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[3]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "c) c_n0", adj = 0.05)
#mtext(side = 3, line = -1.5, "c) c_n", adj = 0.05)
mtext(side = 3, line = -1.5, expression(c*")"~c[n]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[4]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
#mtext(side = 3, line = -1.5, "d) a_m", adj = 0.05)
mtext(side = 3, line = -1.5, expression(d*")"~a[m]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[5]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "e) b_m", adj = 0.05)
mtext(side = 3, line = -1.5, expression(e*")"~b[n]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[6]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "f) c_m", adj = 0.05)
mtext(side = 3, line = -1.5, expression(f*")"~c[m]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[7]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
#mtext(side = 3, line = -1.5, "g) Amax", adj = 0.05)
mtext(side = 3, line = -1.5, expression(g*")"~A[max]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[8]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "h) Amin", adj = 0.05)
mtext(side = 3, line = -1.5, expression(h*")"~A[min]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[9]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "i) g0", adj = 0.05)
#mtext(side = 3, line = -1.5, "i) g", adj = 0.05)
mtext(side = 3, line = -1.5, expression(i*")"~g), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[10]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
#mtext(side = 3, line = -1.5, "j) A_Fmn", adj = 0.05)
mtext(side = 3, line = -1.5, expression(j*")"~A[Fmn]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[11]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "k) Fexp", adj = 0.05)
mtext(side = 3, line = -1.75, expression(k*")"~"F"[exp]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

psim <- sensL7[[12]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1, labels = NA)
#mtext(side = 3, line = -1.5, "l) Fconst", adj = 0.05)
mtext(side = 3, line = -1.5, expression(l*")"~"F"[const]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)


psim <- sensL7[[13]]
plot(x = p_x, y = (psim$Heq1[ ,3]-dH1eq[1])/dH1eq[1]*100, type = "l", lty = 3, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n")
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1)
#mtext(side = 3, line = -1.5, "m) Apatch", adj = 0.05)
mtext(side = 3, line = -1.75, expression(m*")"~A[patch]), adj = 0.05)
lines(x = p_x, y = (psim$Heq1[ ,4]-dH1eq[2])/dH1eq[2]*100, lty = 2, lwd = 2)
lines(x = p_x, y = (psim$Heq1[ ,5]-dH1eq[3])/dH1eq[3]*100, lty = 1, lwd = 2)

plot(x = 0, y = 0, type = "n", ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", frame.plot = F)
legend("left", c("1", "2", "3"), lty = c(3, 2, 1, 1), col = c("black", "black", "black"), ncol = 2, lwd = 2, title = "Size class", bty = "n", cex = 1.2)

# c(a_n, b_n, c_n0, a_m, b_m, c_m, Amax, Amin, g0, Fmn, Fexp, Fconst, Apatch)


#dev.off()

```


plot total host area and fecundity


```{r}

# plot results
ymn <- -0.45*100
ymx <- 0.45*100

yax <- seq(-0.4, 0.4, by = 0.2)*100
xax <- seq(-0.2, 0.2, by = 0.1)*100


# get default values
dH1eq <- c(dsim1$H[1,tmax], dsim1$H[2,tmax], dsim1$H[3,tmax])
dAeq <- sum(dsim1$H[ ,tmax]*c(Fmn/2, (0.9*Amax+Fmn)/2, (Amax+0.9*Amax)/2))

A12 <- Fmn
A23 <- 0.9*Amax

FH_df <- c(0, avg_fec(Fmn, 0.9*Amax, plist_def$Fmn, plist_def$Fconst, plist_def$Fexp), avg_fec(0.9*Amax, Amax, plist_def$Fmn, plist_def$Fconst, plist_def$Fexp))
Atot_df <- sum(dsim1$H[,tmax]*A_mids)

dFeq <- (dsim1$H[2,tmax]*FH_df[2] + dsim1$H[3,tmax]*FH_df[3])*max(0, 1-Atot_df/Apatch)

HAcol <- "#775B24"
HFcol <-  "#BCA888"

p_x <- seq(from = -px, to = px, length.out = 10)*100

# c(a_n, b_n, c_n0, a_m, b_m, c_m, Dinf, g0, Fmn, Fexp, Fconst, Apatch)

#pdf("figures/sensHAF.pdf", width = 6, height = 8)
par(mfrow = c(5, 3))
layout(matrix(c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15), nrow = 5, ncol = 3, byrow = T), widths = rep(1, 3), heights = rep(1, 5))
#layout.show(10)
par(mar=c(0, 1.25, 0.5, 0), oma = c(3.5, 3, 0.5, 0.5))

psim <- sensL7[[1]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
mtext(side = 3, line = -1.5, expression(a*")"~a[n]), adj = 0.05)
mtext(side = 2, line = 1.5, "% change in total host cover or fecundity", outer = T)
mtext(side = 1, line = 2.1, "% change in parameter", outer = T)


psim <- sensL7[[2]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(b*")"~b[n]), adj = 0.05)

psim <- sensL7[[3]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(c*")"~c[n]), adj = 0.05)

psim <- sensL7[[4]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
mtext(side = 3, line = -1.5, expression(d*")"~a[m]), adj = 0.05)

psim <- sensL7[[5]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(e*")"~b[n]), adj = 0.05)

psim <- sensL7[[6]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(f*")"~c[m]), adj = 0.05)

psim <- sensL7[[7]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
mtext(side = 3, line = -1.5, expression(g*")"~A[max]), adj = 0.05)

psim <- sensL7[[8]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(h*")"~A[min]), adj = 0.05)

psim <- sensL7[[9]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(i*")"~g), adj = 0.05)

psim <- sensL7[[10]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax, labels = NA)
axis(side = 2, at = yax, las = 1)
mtext(side = 3, line = -1.5, expression(j*")"~A[Fmn]), adj = 0.05)

psim <- sensL7[[11]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.75, expression(k*")"~"F"[exp]), adj = 0.05)

psim <- sensL7[[12]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1, labels = NA)
mtext(side = 3, line = -1.5, expression(l*")"~"F"[const]), adj = 0.05)

psim <- sensL7[[13]]
plot(x = p_x, y = (psim$Heq1[ ,1]-dAeq)/dAeq*100, type = "l", lty = 1, lwd = 2, ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", col = HAcol)
lines(x = p_x, y = (psim$HFeq1-dFeq)/dFeq*100, lty = 1, lwd = 2, col = HFcol)
axis(side = 1, at = xax)
axis(side = 2, at = yax, las = 1)
mtext(side = 3, line = -1.75, expression(m*")"~A[patch]), adj = 0.05)

plot(x = 0, y = 0, type = "n", ylim = c(ymn, ymx), las = 1, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", frame.plot = F)
legend("left", c("total cover", "total fecundity"), lty = c(1, 1), col = c(HAcol, HFcol), ncol = 1, lwd = 2, bty = "n", cex = 1.2, title = "Host metric")

# c(a_n, b_n, c_n0, a_m, b_m, c_m, Amax, Amin, g0, Fmn, Fexp, Fconst, Apatch)

#dev.off()

```

## initial condition dependence

check for initial condition dependence

```{r}

# repeat for Nutritional and Defensive mutualism with several phi values, just include one in the SM as an example

H0mat <- matrix(NA, nrow = 6, ncol = 3)
H0mat[1,] <- c(0.01, 0.01, 0.01)
H0mat[2,] <- c(100, 0.01, 0.01)
H0mat[3,] <- c(0.01, 100, 0.01)
H0mat[4,] <- c(0.01, 0.01, 100)
H0mat[5,] <- c(100, 80, 0.01)
H0mat[6,] <- c(0.01, 80, 50)

P0mat <- matrix(NA, nrow = 6, ncol = 3)
P0mat[1,] <- c(0.01, 0.01, 0.01)
P0mat[2,] <- c(500, 1, 1)
P0mat[3,] <- c(1, 500, 1)
P0mat[4,] <- c(1, 1, 500)
P0mat[5,] <- c(500, 400, 1)
P0mat[6,] <- c(1, 500, 200)

phi_test1 <- 0#0.9

# Nutritional mutualism
G_pars.IC <- G_pars
G_pars.IC$exp_g <- 1
nH_pars.IC <- nH_pars
nH_pars.IC$exp_cn <- 0

sims.IC.N <- list()

for(i in 1:nrow(H0mat)){
  
  sim.i <- mod_fun3(tmax, P0 = P0mat[i,], H0 = H0mat[i,], rP, nP, mP_pars, eP, nH_pars.IC, mH_pars, G_pars.IC, F_pars, eH, Apatch, z, phi = phi_test1)
  
  sims.IC.N[[i]] <- sim.i
  
}

# Defensive mutualism
G_pars.IC <- G_pars
G_pars.IC$exp_g <- 0
nH_pars.IC <- nH_pars
nH_pars.IC$exp_cn <- 1

sims.IC.D <- list()

for(i in 1:nrow(H0mat)){
  
  sim.i <- mod_fun3(tmax, P0 = P0mat[i,], H0 = H0mat[i,], rP, nP, mP_pars, eP, nH_pars.IC, mH_pars, G_pars.IC, F_pars, eH, Apatch, z, phi = phi_test1)
  
  sims.IC.D[[i]] <- sim.i
  
}

```


plot results
```{r}

col_set <- c("#3e2926", "#634c54", "#8b7162", "#a9a196", "#cfae9f", "#d3bac0")


xaxt1 <- seq(from = 0, to = 1000, by = 250)
yaxt1 <- seq(from = 0, to = 100, by = 25)
yaxt2 <- seq(from = 0, to = 2000, by = 500)

#pdf("figures/IC_plots.pdf", width = 7, height = 5)
par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2, byrow = F), widths = rep(1, 2), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 4.5, 2, 0.5))

# host, Nutritional mutualism
plot(x = sim.i$t, y = sims.IC.N[[1]]$H[1,], type = "l", lty = 3, col = col_set[i], ylim = c(0, 100), lwd = 2, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt1, las = 1)
mtext(side = 3, "Nutritional mutualism")
mtext(side = 2, "Number of hosts", line = 2.5)
for(i in 1:nrow(H0mat)){
  lines(x = sim.i$t, y = sims.IC.N[[i]]$H[1,], type = "l", lty = 3, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.N[[i]]$H[2,], type = "l", lty = 2, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.N[[i]]$H[3,], type = "l", lty = 1, col = col_set[i], lwd = 2)
}
legend("topright", legend = c("1", "2", "3"), lty = c(3, 2, 1), title = "Host size class", bty = "n", lwd = 2)


# partner, Nutritional mutualism
plot(x = sim.i$t, y = sims.IC.N[[1]]$P[1,], type = "l", lty = 3, col = col_set[i], ylim = c(0, 2000), lwd = 2, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt2, las = 1)
mtext(side = 2, "Number of partners", line = 3)
mtext(side = 1, "Time (months)", line = 2.5, outer = T)
for(i in 1:nrow(H0mat)){
  lines(x = sim.i$t, y = sims.IC.N[[i]]$P[1,], type = "l", lty = 3, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.N[[i]]$P[2,], type = "l", lty = 2, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.N[[i]]$P[3,], type = "l", lty = 1, col = col_set[i], lwd = 2)
}


# host, Defensive mutualism
plot(x = sim.i$t, y = sims.IC.D[[1]]$H[1,], type = "l", lty = 3, col = col_set[i], ylim = c(0, 100), lwd = 2, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1, labels = NA)
axis(side = 2, at = yaxt1, labels = NA)
mtext(side = 3, "Defensive mutualism")
for(i in 1:nrow(H0mat)){
  lines(x = sim.i$t, y = sims.IC.D[[i]]$H[1,], type = "l", lty = 3, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.D[[i]]$H[2,], type = "l", lty = 2, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.D[[i]]$H[3,], type = "l", lty = 1, col = col_set[i], lwd = 2)
}


# partner, Defensive mutualism
plot(x = sim.i$t, y = sims.IC.D[[1]]$P[1,], type = "l", lty = 3, col = col_set[i], ylim = c(0, 2000), lwd = 2, xaxt = "n", yaxt = "n")
axis(side = 1, at = xaxt1)
axis(side = 2, at = yaxt2, labels = NA)
for(i in 1:nrow(H0mat)){
  lines(x = sim.i$t, y = sims.IC.D[[i]]$P[1,], type = "l", lty = 3, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.D[[i]]$P[2,], type = "l", lty = 2, col = col_set[i], lwd = 2)
  lines(x = sim.i$t, y = sims.IC.D[[i]]$P[3,], type = "l", lty = 1, col = col_set[i], lwd = 2)
}

#dev.off()

```


## I0 vs ESS

check whether the ESS depends on initial invader size

```{r}

I0set <- seq(from = 0.005, to = 1, length.out = 5)

# Nutritional mutualism
G_pars.I0 <- G_pars
G_pars.I0$exp_g <- 1
nH_pars.I0 <- nH_pars
nH_pars.I0$exp_cn <- 0

# get initial conditions
sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)

P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]

I0_phiN <- rep(NA, length(I0set))

for(i in 1:length(I0set)){
  
  # now get the evo phi values
I0_N <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = P0.5, I0 = I0set[i], H0.5, rP, nP, mP_pars, eP, phi = phiRI, nH_pars.I0, mH_pars, G_pars.I0, F_pars, eH, Apatch, z, eqtol)

indx <- max(which(is.na(I0_N$phiR)==F))

I0_phiN[i] <- (I0_N$phiR[indx] + I0_N$phiR[indx-1])/2
  
}

#evo_ess$phiR

# Defensive mutualism
G_pars.I0 <- G_pars
G_pars.I0$exp_g <- 0
nH_pars.I0 <- nH_pars
nH_pars.I0$exp_cn <- 1

# get initial conditions
sim1 <- mod_fun3(tmax, P0 = R0.0, H0 = H0.0, rP, nP, mP_pars, eP, nH_pars.3, mH_pars, G_pars.3, F_pars, eH, Apatch, z, phi = 0.5)

P0.5 <- sim1$P[,tmax]
H0.5 <- sim1$H[,tmax]

I0_phiD <- rep(NA, length(I0set))

for(i in 1:length(I0set)){
  
  # now get the evo phi values
I0_D <- AD_fun2(n_mut, t_r, mut_size, tmax = 100, R0 = P0.5, I0 = I0set[i], H0.5, rP, nP, mP_pars, eP, phi = phiRI, nH_pars.I0, mH_pars, G_pars.I0, F_pars, eH, Apatch, z, eqtol)

indx <- max(which(is.na(I0_D$phiR)==F))

I0_phiD[i] <- (I0_D$phiR[n_mut] + I0_D$phiR[n_mut-1])/2
  
}

```


```{r}

I0_phiN

I0_phiD

# I0 has minimal effects on phi ESS

```



## ecoevo with Hopt

add the host optimizing phi value to the ecoevo plot 

```{r}
# plot results

Dcol <- "#7B8BA5"
Ncol <- "#B66A40"
Dfcol <- "gray"

lwd.1 <- 2.5
lty.eco <- 1
lty.evo <- 2

lty.H <- 3

ylims.1 <- c(0, 1.1)

yaxs <- seq(from = ylims.1[1], to = 1, by = 0.2)


#pdf("figures/eco_evo_Hopt.pdf", width = 8, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2, byrow = T), widths = rep(1, 2), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 4.5, 2, 0.5))


#g0_set
xset <- exp_g_set
xlab <- NA
xaxs <- seq(from = exp_g_set[1], to = exp_g_set[length1], by = 0.5)

ecoevo.p <- ecoevo.exp_g.HmP 
ecoH.p <- ecoH.exp_g.HmP$eco_phi[2:length1]

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1, labels = NA)
mtext(side = 3, "Nutritional mutualism")
#mtext(side = 3, "a) Nutritional mutualism, strong size effect on P", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 3, "a) Nutritional, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, xlab, line = 2.5)
#mtext(side = 2, "Strength of partner preference for adult hosts (phi)", line = 1.25, outer = T)
mtext(side = 2, expression(Strength~of~partner~preference~'for'~adult~hosts~(phi)), line = 1.25, outer = T)
lines(x = xset, y = ecoevo.p$evo_phi, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoH.p, col = Ncol, lty = lty.H, lwd = lwd.1)
#legend("bottomleft", legend = c("Biomass maximizing", "Partner ESS"), lty = c(lty.eco, lty.evo), lwd = lwd.1, bty = "n", col = "gray20")


ecoevo.p <- ecoevo.exp_cn.HmP 
ecoH.p <- ecoH.exp_cn.HmP$eco_phi[2:length1]

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "Defensive mutualism")
mtext(side = 3, "b) Defensive, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
axis(side = 1, at = xaxs, las = 1, labels = NA)
axis(side = 2, at = yaxs, las = 1, labels = NA)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$evo_phi, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoH.p, col = Dcol, lty = lty.H, lwd = lwd.1)
legend("right", legend = c("Partner maximizing", "Partner ESS", "Host maximizing"), lty = c(lty.eco, lty.evo, lty.H), lwd = lwd.1, bty = "n", col = "gray20")

ecoevo.p <- ecoevo.exp_g.LmP 
ecoH.p <- ecoH.exp_g.LmP$eco_phi[2:length1]

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
#mtext(side = 1, "Strength of nutritional mutualism", line = 2)
mtext(side = 1, "Strength of partner effects on host", line = 2.5, outer = T)
mtext(side = 3, "c) Nutritional, weak host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$evo_phi, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoH.p, col = Ncol, lty = lty.H, lwd = lwd.1)


ecoevo.p <- ecoevo.exp_cn.LmP 
ecoH.p <- ecoH.exp_cn.LmP$eco_phi[2:length1]

plot(x = xset, y = ecoevo.p$eco_phi, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "d) Defensive, weak host size effect on P", adj = 0.05, line = -1, cex = 0.9)
#mtext(side = 1, "Strength of defensive mutualism", line = 2)
axis(side = 1, at = xaxs, las = 1)
axis(side = 2, at = yaxs, las = 1, labels = NA)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$evo_phi, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoH.p, col = Dcol, lty = lty.H, lwd = lwd.1)

#dev.off()


```



## ecoevo P and H abundances

Plot equilibrium partner and host abundances at partner maximizing and ESS phi values

```{r}


# for each scenario, need to get total P and total H area at the P-optimizing phi value, the P ESS phi value, and the HA optimizing phi value

# make a function for calculating these values

#ecoevo_set <- ecoevo.exp_g.HmP
#ecoH_set <- ecoH.exp_g.HmP

ecoevoPH_fun <- function(ecoevo_set, ecoH_set){
  
Ptot_Popt <- rep(NA, length1)
HA_Popt <- rep(NA, length1)

Ptot_ESS <- rep(NA, length1)
HA_ESS <- rep(NA, length1)

Ptot_Hopt <- rep(NA, length1)
HA_Hopt <- rep(NA, length1)

for(i in 1:length1){
  
Ptot_Popt[i] <- ecoevo_set$eco_list[[i]]$P
HA_Popt[i] <- ecoevo_set$eco_list[[i]]$HA

end_m <- max(which(is.na(ecoevo_set$evo_list[[i]]$Heqs[,1])==F))

Ptot_ESS[i] <- (ecoevo_set$evo_list[[i]]$Reqs[end_m, 1] + ecoevo_set$evo_list[[i]]$Reqs[end_m-1, 1])/2
HA_ESS[i] <- (ecoevo_set$evo_list[[i]]$Heqs[end_m, 1] + ecoevo_set$evo_list[[i]]$Heqs[end_m-1, 1])/2

Ptot_Hopt[i] <- ecoH_set$eco_list[[i]]$P
HA_Hopt[i] <- ecoH_set$eco_list[[i]]$HA
  
  
}

return(list(Ptot_Popt = Ptot_Popt, HA_Popt = HA_Popt, Ptot_ESS = Ptot_ESS, HA_ESS = HA_ESS, Ptot_Hopt = Ptot_Hopt, HA_Hopt = HA_Hopt))
  
}



```


```{r}

# plot for nutritional mutualism

ylims.1 <- c(0, 600)

yaxs <- seq(from = ylims.1[1], to = ylims.1[2], by = 100)

ylims.2 <- c(0, 80000)
yaxs2 <- seq(from = ylims.2[1], to = ylims.2[2], by = 20000)

lwd.1 <- 2.5

#pdf("figures/eco_evo_nutPH.pdf", width = 8.5, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2, byrow = T), widths = rep(1, 2), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 3.75), oma = c(4.5, 4.5, 2, 0))


#g0_set
xset <- exp_g_set
xlab <- NA
xaxs <- seq(from = exp_g_set[1], to = exp_g_set[length1], by = 0.5)

ecoevo.p <- ecoevoPH_fun(ecoevo.exp_g.HmP, ecoH.exp_g.HmP)

plot(x = xset, y = ecoevo.p$Ptot_Popt, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1, labels = NA)
mtext(side = 3, "a) P*, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, xlab, line = 2.5)
mtext(side = 3, "Equilibrium partner population size")
mtext(side = 2, "Number of partners", line = 1.75, outer = T, cex = 1.2)
lines(x = xset, y = ecoevo.p$Ptot_ESS, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$Ptot_Hopt[2:length1], col = Ncol, lty = lty.H, lwd = lwd.1)
legend("bottomright", legend = c("Partner maximizing", "Partner ESS", "Host maximizing"), lty = c(lty.eco, lty.evo, lty.H), lwd = lwd.1, bty = "n", col = Ncol)
#legend("bottomleft", legend = c("Biomass maximizing", "Partner ESS"), lty = c(lty.eco, lty.evo), lwd = lwd.1, bty = "n", col = "gray20")


#ecoevo.p <- ecoevoPH_fun(ecoevo.exp_cn.HmP, ecoH.exp_cn.HmP)

plot(x = xset, y = ecoevo.p$HA_Popt, ylim = ylims.2, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "b) H*, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 2, "Host cover", line = 3.5, adj = -0.25, cex = 1.2)
mtext(side = 3, "Equilibrium host cover")
axis(side = 1, at = xaxs, las = 1, labels = NA)
axis(side = 2, at = yaxs2, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$HA_ESS, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$HA_Hopt[2:length1], col = Ncol, lty = lty.H, lwd = lwd.1)


# ylims.1 <- c(0, 2000)
# 
# yaxs <- seq(from = ylims.1[1], to = ylims.1[2], by = 50)

ecoevo.p <- ecoevoPH_fun(ecoevo.exp_g.LmP, ecoH.exp_g.LmP)

plot(x = xset, y = ecoevo.p$Ptot_Popt, ylim = ylims.1, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
mtext(side = 1, "Strength of nutritional mutualism", line = 2)
mtext(side = 3, "c) P*, weak host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$Ptot_ESS, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$Ptot_Hopt[2:length1], col = Ncol, lty = lty.H, lwd = lwd.1)


plot(x = xset, y = ecoevo.p$HA_Popt, ylim = ylims.2, type = "l", las = 1, col = Ncol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "d) H*, weak host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, "Strength of nutritional mutualism", line = 2)
axis(side = 1, at = xaxs, las = 1)
axis(side = 2, at = yaxs2, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$HA_ESS, col = Ncol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$HA_Hopt[2:length1], col = Ncol, lty = lty.H, lwd = lwd.1)

#dev.off()

```


```{r}

# plot for defensive mutualism

ylims.1 <- c(0, 800)

yaxs <- seq(from = ylims.1[1], to = ylims.1[2], by = 200)

ylims.2 <- c(0, 100000)
yaxs2 <- seq(from = ylims.2[1], to = ylims.2[2], by = 25000)

#pdf("figures/eco_evo_defPH.pdf", width = 8.5, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1, 2, 3, 4), nrow = 2, ncol = 2, byrow = T), widths = rep(1, 2), heights = rep(1, 2))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 3.75), oma = c(4.5, 4.5, 2, 0))


#g0_set
xset <- exp_g_set
xlab <- NA
xaxs <- seq(from = exp_cn_set[1], to = exp_cn_set[length1], by = 0.5)

ecoevo.p <- ecoevoPH_fun(ecoevo.exp_cn.HmP, ecoH.exp_cn.HmP)

plot(x = xset, y = ecoevo.p$Ptot_Popt, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1, labels = NA)
mtext(side = 3, "a) P*, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 3, "Equilibrium partner population size")
mtext(side = 1, xlab, line = 2.5)
mtext(side = 2, "Number of partners", line = 1.75, outer = T, cex = 1.2)
lines(x = xset, y = ecoevo.p$Ptot_ESS, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$Ptot_Hopt[2:length1], col = Dcol, lty = lty.H, lwd = lwd.1)
legend("bottomright", legend = c("Partner maximizing", "Partner ESS", "Host maximizing"), lty = c(lty.eco, lty.evo, lty.H), lwd = lwd.1, bty = "n", col = Dcol)
#legend("bottomleft", legend = c("Biomass maximizing", "Partner ESS"), lty = c(lty.eco, lty.evo), lwd = lwd.1, bty = "n", col = "gray20")


#ecoevo.p <- ecoevoPH_fun(ecoevo.exp_cn.HmP, ecoH.exp_cn.HmP)

plot(x = xset, y = ecoevo.p$HA_Popt, ylim = ylims.2, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "b) H*, strong host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 3, "Equilibrium host cover")
mtext(side = 2, "Host cover", line = 3.5, adj = -0.25, cex = 1.2)
axis(side = 1, at = xaxs, las = 1, labels = NA)
axis(side = 2, at = yaxs2, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$HA_ESS, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$HA_Hopt[2:length1], col = Dcol, lty = lty.H, lwd = lwd.1)


# ylims.1 <- c(0, 2000)
# 
# yaxs <- seq(from = ylims.1[1], to = ylims.1[2], by = 50)

ecoevo.p <- ecoevoPH_fun(ecoevo.exp_cn.LmP, ecoH.exp_cn.LmP)

plot(x = xset, y = ecoevo.p$Ptot_Popt, ylim = ylims.1, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", ylab = NA, xlab = NA)
mtext(side = 1, "Strength of defensive mutualism", line = 2)
mtext(side = 3, "c) P*, weak host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
axis(side = 2, at = yaxs, las = 1)
axis(side = 1, at = xaxs, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$Ptot_ESS, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$Ptot_Hopt[2:length1], col = Dcol, lty = lty.H, lwd = lwd.1)


plot(x = xset, y = ecoevo.p$HA_Popt, ylim = ylims.2, type = "l", las = 1, col = Dcol, lty = lty.eco, lwd = lwd.1, yaxt = "n", xaxt = "n", xlab = NA, ylab = NA)
mtext(side = 3, "d) H*, weak host size effect on partner", adj = 0.05, line = -1, cex = 0.9)
mtext(side = 1, "Strength of defensive mutualism", line = 2)
axis(side = 1, at = xaxs, las = 1)
axis(side = 2, at = yaxs2, las = 1)
mtext(side = 1, xlab, line = 2.5)
lines(x = xset, y = ecoevo.p$HA_ESS, col = Dcol, lty = lty.evo, lwd = lwd.1)
lines(x = xset[2:length1], y = ecoevo.p$HA_Hopt[2:length1], col = Dcol, lty = lty.H, lwd = lwd.1)

#dev.off()

```


## sensitivity

for each parameter, calculate partner maximizing and ESS phi values for default value, x% decrease, and x% increase, and plot the resulting phi values. Do this for the non-mutualism parameters, and repeat for default (no P effects), Nutritional mutualism, and Defensive mutualism 


```{r}

# list of parameters to test senstivity to (all model parameters except slope_mP, eP, exp_cn, exp_g, eH, z, Amax, Amin)
# psens <- list(rP = rP, nP = nP, K0 = K0, a_n = a_n, b_n = b_n, c_n0 = c_n0, cn_mn = cn_mn, a_m = a_m, b_m = b_m, c_m = c_m, g0 = g0, g_mx = g_mx, Fmn = Fmn, Fconst = Fconst, Fexp = Fexp, Apatch = Apatch)

# length(psens)
# 
# names(psens)
# 
# psens[[which(names(psens)=="c_m")]]
# psens[[which(names(psens)=="c_m")]] <- 1
# psens[[which(names(psens)=="c_m")]]

```



```{r}

psens <- list(rP = rP, nP = nP, K0 = K0, a_n = a_n, b_n = b_n, c_n0 = c_n0, cn_mn = cn_mn, a_m = a_m, b_m = b_m, c_m = c_m, g0 = g0, g_mx = g_mx, Fmn = Fmn, Fconst = Fconst, Fexp = Fexp, Apatch = Apatch)


x1 <- 0.1 # can't be too high because if partner growth rate is too high there will be population cycling



#EcoEvo_fun(par_choice, par_set, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars.1, eP, nH_pars.1, mH_pars, G_pars.1, F_pars, eH, Apatch, z, phi, phiRI)

tic()

# Nutritional mutualism
G_pars.1s <- G_pars
nH_pars.1s <- nH_pars
G_pars.1s$exp_g <- 1
nH_pars.1s$exp_cn <- 0

ecoevo_sens <- EcoEvoSens_fun(psens, x = x1, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.1s, mH_pars, G_pars.1s, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo_sens$eco_eq)
max(ecoevo_sens$evo_eq)

ecoevo_sens.exp_g <- ecoevo_sens

# Defensive mutualism
G_pars.1s <- G_pars
nH_pars.1s <- nH_pars
G_pars.1s$exp_g <- 0
nH_pars.1s$exp_cn <- 1

ecoevo_sens <- EcoEvoSens_fun(psens, x = x1, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.1s, mH_pars, G_pars.1s, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo_sens$eco_eq)
max(ecoevo_sens$evo_eq)

ecoevo_sens.exp_cn <- ecoevo_sens

# no mutualism
G_pars.1s <- G_pars
nH_pars.1s <- nH_pars
G_pars.1s$exp_g <- 0
nH_pars.1s$exp_cn <- 0

ecoevo_sens <- EcoEvoSens_fun(psens, x = x1, tmax, P0 = R0.0, H0 = H0.0, I0 = I0.1, rP, nP, mP_pars, eP, nH_pars.1s, mH_pars, G_pars.1s, F_pars, eH, Apatch, z, phi, phiRI)

max(ecoevo_sens$eco_eq)
max(ecoevo_sens$evo_eq)

ecoevo_sens.0 <- ecoevo_sens


toc() # takes about 50 min

#ecoevo_sens.0$eco_phi
#ecoevo_sens.0$evo_phi



```



```{r}

# check output

# max(ecoevo_sens$eco_eq)
# max(ecoevo_sens$evo_eq)
# 
# ecoevo_sens.exp_g$evo_eq # NA's because phi reached ess and simulation stopped so there were NAs
# 
# ecoevo_sens.exp_g$evo_phi
# 
# ecoevo_sens.exp_g$evo_list_full[[2]][[3]]$phiR
# 
# ecoevo_sens.exp_g$evo_list_full[[6]][[1]]$phiR

```



```{r}
# update the parameter names so they match the names used in the main text

psensp <- psens
names(psensp)[which(names(psens)=="Fmn")] <- "A_Fmn"
names(psensp)[which(names(psens)=="cn_mn")] <- "c_min"
names(psensp)[which(names(psens)=="K0")] <- "K_0"
names(psensp)[which(names(psens)=="g_mx")] <- "g_max"


#names(psensp)

```


### phi values

```{r}



Dcol <- "#7B8BA5"
Ncol <- "#B66A40"
Dfcol <- "gray"

lwd.1 <- 1.5
lty.eco <- 1
lty.evo <- 2

pch.1 <- 16
pch.cex <- 1

ylims.2 <- c(0, 1.1)

yaxs <- seq(from = ylims.2[1], to = ylims.2[2], by = 0.2)

panel_labs <- c("a)", "b)", "c)", "d)", "e)", "f)", "g)", "h)", "i)", "j)", "k)", "l)", "m)", "n)", "o)", "p)")

xlabs <- c("-10%", "Default", "+10%")

#pdf("figures/eco_evo_sens.pdf", width = 8, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1:16), nrow = 4, ncol = 4, byrow = T), widths = rep(1, 4), heights = rep(1, 4))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 3.5, 1.5, 0.5))

j <- 1
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(a*")"~r[P]), line = -1.4, adj = 0.1, cex = 0.9)
#mtext(side = 2, "Strength of partner preference for adult hosts (phi)", line = 1.25, outer = T)
mtext(side = 2, expression(Strength~of~partner~preference~'for'~adult~hosts~(phi)), line = 1.25, outer = T)

j <- 2
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(b*")"~n[P]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 3
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(c*")"~K[0]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 4
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(d*")"~a[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 5
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(e*")"~b[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 6
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(f*")"~c["n0"]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 7
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(g*")"~c["n,mn"]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 8
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(h*")"~a[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 9
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(i*")"~b[m]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 10
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(j*")"~c[m]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 11
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(k*")"~g[0]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 12
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(l*")"~g[mx]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 13
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(m*")"~"F"[mn]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 14
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(n*")"~"F"[const]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 15
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(o*")"~"F"[exp]), line = -1.5, adj = 0.1, cex = 0.9)

j <- 16
eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- ecoevo_sens.exp_cn$eco_phi; evo_phi.p <- ecoevo_sens.exp_cn$evo_phi
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
eco_phi.p <- ecoevo_sens.exp_g$eco_phi; evo_phi.p <- ecoevo_sens.exp_g$evo_phi
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
lines(x = c(1:3), y = evo_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.evo, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(p*")"~A[patch]), line = -1.5, adj = 0.1, cex = 0.9)
mtext(side = 1, "Change in parameter", outer = T, line = 2.5)


#dev.off()

#paste("a)", names(psens)[j], sep = " ")


```



```{r}

# names(psens)[6]
# 
# ecoevo_sens.0$eco_list_full[[6]][[1]]$P
# ecoevo_sens.0$eco_list_full[[6]][[2]]$P
# ecoevo_sens.0$eco_list_full[[6]][[3]]$P
# 
# 
# ecoevo_sens.0$evo_list_full[[6]][[1]]$Reqs[n_mut,1]
# ecoevo_sens.0$evo_list_full[[6]][[2]]$Reqs[n_mut,1]
# ecoevo_sens.0$evo_list_full[[6]][[3]]$Reqs[n_mut,1]
# 
# (c(ecoevo_sens.0$eco_list_full[[6]][[1]]$P, ecoevo_sens.0$eco_list_full[[6]][[2]]$P, ecoevo_sens.0$eco_list_full[[6]][[3]]$P)-c(ecoevo_sens.0$evo_list_full[[6]][[1]]$Reqs[n_mut,1], ecoevo_sens.0$evo_list_full[[6]][[2]]$Reqs[n_mut,1], ecoevo_sens.0$evo_list_full[[6]][[3]]$Reqs[n_mut,1]))/c(ecoevo_sens.0$evo_list_full[[6]][[1]]$Reqs[n_mut,1], ecoevo_sens.0$evo_list_full[[6]][[2]]$Reqs[n_mut,1], ecoevo_sens.0$evo_list_full[[6]][[3]]$Reqs[n_mut,1])*100

```

### Pdiff

calculate percent differences in parter equilibria between partner maximizing and partner ESS phi values


```{r}

#ecoevo_sens.0$eco_list_full[[j]][[1]]$P

#ecoevo_sens.0$evo_list_full[[j]][[1]]$Reqs

# for each j, need to get [[1]], [[2]], and [[3]] for each, calculate % difference between eco and evo, and store everything as a row in a matrix (j rows total)

#eco_phi.p <- ecoevo_sens.0$eco_phi; evo_phi.p <- ecoevo_sens.0$evo_phi


pdiff_mat.0 <- matrix(NA, nrow = length(psens), ncol = 3)
pdiff_mat.exp_g <- matrix(NA, nrow = length(psens), ncol = 3)
pdiff_mat.exp_cn <- matrix(NA, nrow = length(psens), ncol = 3)

for(j in 1:length(psens)){
#for(j in 1:6){
  
  ecoj <- ecoevo_sens.0$eco_list_full[[j]]
  evoj <- ecoevo_sens.0$evo_list_full[[j]]
  
  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))
  
  ecojP <- c(ecoj[[1]]$P, ecoj[[2]]$P, ecoj[[3]]$P)
  evojP <- c((evoj[[1]]$Reqs[indx1,1] + evoj[[1]]$Reqs[indx1-1,1])/2, (evoj[[2]]$Reqs[indx2,1] + evoj[[2]]$Reqs[indx2-1,1])/2, (evoj[[3]]$Reqs[indx3,1] + evoj[[3]]$Reqs[indx3-1,1])/2)
  
  pdiff_mat.0[j,] <- (ecojP-evojP)/evojP*100 #(ecoevo_def$eco_list[[1]]$P-denom)/denom
  
  ecoj <- ecoevo_sens.exp_g$eco_list_full[[j]]
  evoj <- ecoevo_sens.exp_g$evo_list_full[[j]]

  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))

  ecojP <- c(ecoj[[1]]$P, ecoj[[2]]$P, ecoj[[3]]$P)
  evojP <- c((evoj[[1]]$Reqs[indx1,1] + evoj[[1]]$Reqs[indx1-1,1])/2, (evoj[[2]]$Reqs[indx2,1] + evoj[[2]]$Reqs[indx2-1,1])/2, (evoj[[3]]$Reqs[indx3,1] + evoj[[3]]$Reqs[indx3-1,1])/2)

  pdiff_mat.exp_g[j,] <- (ecojP-evojP)/evojP*100

  ecoj <- ecoevo_sens.exp_cn$eco_list_full[[j]]
  evoj <- ecoevo_sens.exp_cn$evo_list_full[[j]]

  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))

  ecojP <- c(ecoj[[1]]$P, ecoj[[2]]$P, ecoj[[3]]$P)
  evojP <- c((evoj[[1]]$Reqs[indx1,1] + evoj[[1]]$Reqs[indx1-1,1])/2, (evoj[[2]]$Reqs[indx2,1] + evoj[[2]]$Reqs[indx2-1,1])/2, (evoj[[3]]$Reqs[indx3,1] + evoj[[3]]$Reqs[indx3-1,1])/2)

  pdiff_mat.exp_cn[j,] <- (ecojP-evojP)/evojP*100

  
  
  
}


```



```{r}
# max(pdiff_mat.0)
# max(pdiff_mat.exp_cn)
# max(pdiff_mat.exp_g)
# 
# min(pdiff_mat.0)
# min(pdiff_mat.exp_cn)
# min(pdiff_mat.exp_g)
# 
# pdiff_mat.exp_g
# 
# pdiff_mat.exp_cn

```




percent difference in partner equilibria

```{r}
#pdiff_mat.0 


Dcol <- "#7B8BA5"
Ncol <- "#B66A40"
Dfcol <- "gray"

lwd.1 <- 2.5
lty.eco <- 1
lty.evo <- 2

pch.1 <- 16
pch.cex <- 1



ylims.2 <- c(0, 15)

yaxs <- seq(from = ylims.2[1], to = ylims.2[2], by = 5)

panel_labs <- c("a)", "b)", "c)", "d)", "e)", "f)", "g)", "h)", "i)", "j)", "k)", "l)", "m)", "n)", "o)", "p)")

xlabs <- c("-10%", "Default", "+10%")

#pdf("figures/eco_evo_sensPdiff.pdf", width = 8, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1:16), nrow = 4, ncol = 4, byrow = T), widths = rep(1, 4), heights = rep(1, 4))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 3.5, 1.5, 0.5))

j <- 1
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(a*")"~r[P]), line = -1.4, adj = 0.1, cex = 0.9)
mtext(side = 2, "% Difference in number of partners", line = 1.25, outer = T)

j <- 2
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(b*")"~n[P]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 3
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(c*")"~K[0]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 4
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(d*")"~a[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 5
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(e*")"~b[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 6
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(f*")"~c["n0"]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 7
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(g*")"~c["n,mn"]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 8
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(h*")"~a[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 9
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(i*")"~b[m]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 10
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(j*")"~c[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 11
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(k*")"~g[0]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 12
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(l*")"~g[mx]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 13
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(m*")"~"F"[mn]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 14
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(n*")"~"F"[const]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 15
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(o*")"~"F"[exp]), line = -1.5, adj = 0.1, cex = 0.9)

j <- 16
eco_phi.p <- pdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- pdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- pdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(p*")"~A[patch]), line = -1.5, adj = 0.1, cex = 0.9)
mtext(side = 1, "Change in parameter", outer = T, line = 2.5)


#dev.off()


```

### HAdiff

repeat for hosts (percent difference in host area)

```{r}
HAdiff_mat.0 <- matrix(NA, nrow = length(psens), ncol = 3)
HAdiff_mat.exp_g <- matrix(NA, nrow = length(psens), ncol = 3)
HAdiff_mat.exp_cn <- matrix(NA, nrow = length(psens), ncol = 3)

for(j in 1:length(psens)){
#for(j in 1:6){
  
  ecoj <- ecoevo_sens.0$eco_list_full[[j]]
  evoj <- ecoevo_sens.0$evo_list_full[[j]]
  
  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))
  
  ecojP <- c(ecoj[[1]]$HA, ecoj[[2]]$HA, ecoj[[3]]$HA)
  evojP <- c((evoj[[1]]$Heqs[indx1,1] + evoj[[1]]$Heqs[indx1-1,1])/2, (evoj[[2]]$Heqs[indx2,1] + evoj[[2]]$Heqs[indx2-1,1])/2, (evoj[[3]]$Heqs[indx3,1] + evoj[[3]]$Heqs[indx3-1,1])/2)
  
  HAdiff_mat.0[j,] <- (ecojP-evojP)/evojP*100 #(ecoevo_def$eco_list[[1]]$H-denom)/denom
  
  ecoj <- ecoevo_sens.exp_g$eco_list_full[[j]]
  evoj <- ecoevo_sens.exp_g$evo_list_full[[j]]

  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))

  ecojP <- c(ecoj[[1]]$HA, ecoj[[2]]$HA, ecoj[[3]]$HA)
  evojP <- c((evoj[[1]]$Heqs[indx1,1] + evoj[[1]]$Heqs[indx1-1,1])/2, (evoj[[2]]$Heqs[indx2,1] + evoj[[2]]$Heqs[indx2-1,1])/2, (evoj[[3]]$Heqs[indx3,1] + evoj[[3]]$Heqs[indx3-1,1])/2)

  HAdiff_mat.exp_g[j,] <- (ecojP-evojP)/evojP*100

  ecoj <- ecoevo_sens.exp_cn$eco_list_full[[j]]
  evoj <- ecoevo_sens.exp_cn$evo_list_full[[j]]

  indx1 <- max(which(is.na(evoj[[1]]$phiR)==F))
  indx2 <- max(which(is.na(evoj[[2]]$phiR)==F))
  indx3 <- max(which(is.na(evoj[[3]]$phiR)==F))

  ecojP <- c(ecoj[[1]]$HA, ecoj[[2]]$HA, ecoj[[3]]$HA)
  evojP <- c((evoj[[1]]$Heqs[indx1,1] + evoj[[1]]$Heqs[indx1-1,1])/2, (evoj[[2]]$Heqs[indx2,1] + evoj[[2]]$Heqs[indx2-1,1])/2, (evoj[[3]]$Heqs[indx3,1] + evoj[[3]]$Heqs[indx3-1,1])/2)

  HAdiff_mat.exp_cn[j,] <- (ecojP-evojP)/evojP*100

  
  
  
}


```


```{r}
# HAdiff_mat.exp_g 
# HAdiff_mat.exp_cn
# 
# min(HAdiff_mat.exp_g)
# max(HAdiff_mat.exp_g)
# min(pdiff_mat.exp_g)
# max(pdiff_mat.exp_g)

```



```{r}
#pdiff_mat.0 


Dcol <- "#7B8BA5"
Ncol <- "#B66A40"
Dfcol <- "gray"

lwd.1 <- 2.5
lty.eco <- 1
lty.evo <- 2

pch.1 <- 16
pch.cex <- 1



ylims.2 <- c(0, 25)

yaxs <- seq(from = ylims.2[1], to = ylims.2[2], by = 5)

panel_labs <- c("a)", "b)", "c)", "d)", "e)", "f)", "g)", "h)", "i)", "j)", "k)", "l)", "m)", "n)", "o)", "p)")

xlabs <- c("-10%", "Default", "+10%")

#pdf("figures/eco_evo_sensHAdiff.pdf", width = 8, height = 6)

par(mfrow = c(2, 2))
layout(matrix(c(1:16), nrow = 4, ncol = 4, byrow = T), widths = rep(1, 4), heights = rep(1, 4))
#layout.show(12)
par(mar=c(0, 1.25, 0.5, 0), oma = c(4.5, 3.5, 1.5, 0.5))

j <- 1
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(a*")"~r[P]), line = -1.4, adj = 0.1, cex = 0.9)
mtext(side = 2, "% Difference in host cover", line = 1.25, outer = T)

j <- 2
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(b*")"~n[P]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 3
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(c*")"~K[0]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 4
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(d*")"~a[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 5
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(e*")"~b[n]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 6
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(f*")"~c["n0"]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 7
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(g*")"~c["n,mn"]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 8
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(h*")"~a[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 9
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(i*")"~b[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 10
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(j*")"~c[m]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 11
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(k*")"~g[0]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 12
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = NA)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(l*")"~g[mx]), line = -1.4, adj = 0.1, cex = 0.9)


j <- 13
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, las = 1)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(m*")"~"F"[mn]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 14
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(n*")"~"F"[const]), line = -1.4, adj = 0.1, cex = 0.9)

j <- 15
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(o*")"~"F"[exp]), line = -1.5, adj = 0.1, cex = 0.9)

j <- 16
eco_phi.p <- HAdiff_mat.0 
col.p <- Dfcol
plot(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p, xlab = NA, ylab = NA, xaxt = "n", yaxt = "n", ylim = ylims.2)
axis(side = 1, at = c(1:3), labels = xlabs)
axis(side = 2, at = yaxs, labels = NA)
eco_phi.p <- HAdiff_mat.exp_cn
col.p <- Dcol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
eco_phi.p <- HAdiff_mat.exp_g
col.p <- Ncol
lines(x = c(1:3), y = eco_phi.p[j,], lwd = lwd.1, type = "o", pch = pch.1, cex = pch.cex, lty = lty.eco, col = col.p)
#mtext(side = 3, paste(panel_labs[j], names(psensp)[j], sep = " "), line = -1.2, adj = 0.1, cex = 0.9)
mtext(side = 3, expression(p*")"~A[patch]), line = -1.5, adj = 0.1, cex = 0.9)
mtext(side = 1, "Change in parameter", outer = T, line = 2.5)


#dev.off()


```
